

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>cwatm.hydrological_modules.water_demand.water_demand &mdash; Community Water Model</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/iiasa.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> Community Water Model
          

          
            
            <img src="../../../../_static/IIASA_logo_white.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../intro.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modeldesign.html">2. Model Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../publication.html">3. Publication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../setup.html">4. Setup of the model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorial.html">5. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../errorHandling.html">6. Error handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../listVariables.html">7. List of output variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../results.html">8. Demo of the model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../todo.html">9. The Model Itself</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../data.html">10. Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../calibration.html">11. Calibration tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../calibration_tutorial.html">12. Calibration tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resolution.html">13. Increasing resolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../zambezi.html">14. Example Zambezi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../license.html">15. License and download info</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sourcecode.html">16. Source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../forum.html">17. Forum</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Community Water Model</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>cwatm.hydrological_modules.water_demand.water_demand</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for cwatm.hydrological_modules.water_demand.water_demand</h1><div class="highlight"><pre>
<span></span><span class="c1"># -------------------------------------------------------------------------</span>
<span class="c1"># Name:        Water demand module</span>
<span class="c1">#</span>
<span class="c1"># Author:      PB, MS, LG, JdeB, DF</span>
<span class="c1">#</span>
<span class="c1"># Created:     15/07/2016</span>
<span class="c1"># Copyright:   (c) PB 2016</span>
<span class="c1"># -------------------------------------------------------------------------</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">cwatm.management_modules</span> <span class="kn">import</span> <span class="nb">globals</span>

<span class="kn">from</span> <span class="nn">cwatm.management_modules.replace_pcr</span> <span class="kn">import</span> <span class="n">npareatotal</span><span class="p">,</span> <span class="n">npareamaximum</span>
<span class="kn">from</span> <span class="nn">cwatm.management_modules.data_handling</span> <span class="kn">import</span> <span class="n">returnBool</span><span class="p">,</span> <span class="n">binding</span><span class="p">,</span> <span class="n">cbinding</span><span class="p">,</span> <span class="n">loadmap</span><span class="p">,</span> <span class="n">divideValues</span><span class="p">,</span> <span class="n">checkOption</span><span class="p">,</span> \
    <span class="n">npareaaverage</span><span class="p">,</span> <span class="n">readnetcdf2</span>
<span class="kn">from</span> <span class="nn">cwatm.hydrological_modules.water_demand.domestic</span> <span class="kn">import</span> <span class="n">waterdemand_domestic</span>
<span class="kn">from</span> <span class="nn">cwatm.hydrological_modules.water_demand.industry</span> <span class="kn">import</span> <span class="n">waterdemand_industry</span>
<span class="kn">from</span> <span class="nn">cwatm.hydrological_modules.water_demand.livestock</span> <span class="kn">import</span> <span class="n">waterdemand_livestock</span>
<span class="kn">from</span> <span class="nn">cwatm.hydrological_modules.water_demand.irrigation</span> <span class="kn">import</span> <span class="n">waterdemand_irrigation</span>
<span class="kn">from</span> <span class="nn">cwatm.hydrological_modules.water_demand.environmental_need</span> <span class="kn">import</span> <span class="n">waterdemand_environmental_need</span>
<span class="kn">from</span> <span class="nn">cwatm.hydrological_modules.water_demand.wastewater</span> <span class="kn">import</span> <span class="n">waterdemand_wastewater</span>

<span class="c1"># PB1507</span>
<span class="kn">from</span> <span class="nn">cwatm.management_modules.data_handling</span> <span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="water_demand"><a class="viewcode-back" href="../../../../hydrological_modules.html#cwatm.hydrological_modules.water_demand.water_demand.water_demand">[docs]</a><span class="k">class</span> <span class="nc">water_demand</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    WATERDEMAND</span>

<span class="sd">    Calculating water demand and attributing sources to satisfy demands</span>
<span class="sd">    Industrial, domestic, and livestock are based on precalculated maps</span>
<span class="sd">    Agricultural water demand based on water need by plants</span>
<span class="sd">    </span>
<span class="sd">    **Global variables**</span>

<span class="sd">    =====================================  ======================================================================  =====</span>
<span class="sd">    Variable [self.var]                    Description                                                             Unit </span>
<span class="sd">    =====================================  ======================================================================  =====</span>
<span class="sd">    modflow                                Flag: True if modflow_coupling = True in settings file                  --   </span>
<span class="sd">    load_initial                           Settings initLoad holds initial conditions for variables                input</span>
<span class="sd">    readAvlStorGroundwater                 same as storGroundwater but equal to 0 when inferior to a treshold      m    </span>
<span class="sd">    includeDesal                                                                                                   --   </span>
<span class="sd">    unlimitedDesal                                                                                                 --   </span>
<span class="sd">    desalAnnualCap                                                                                                 --   </span>
<span class="sd">    reservoir_transfers                    [[&#39;Giving reservoir&#39;][i], [&#39;Receiving reservoir&#39;][i], [&#39;Fraction of li  array</span>
<span class="sd">    loadInit                               Flag: if true initial conditions are loaded                             --   </span>
<span class="sd">    efficiencyPaddy                        Input, irrPaddy_efficiency, paddy irrigation efficiency, the amount of  frac </span>
<span class="sd">    efficiencyNonpaddy                     Input, irrNonPaddy_efficiency, non-paddy irrigation efficiency, the am  frac </span>
<span class="sd">    returnfractionIrr                      Input, irrigation_returnfraction, the fraction of non-efficient water   frac </span>
<span class="sd">    irrPaddyDemand                         Paddy irrigation demand                                                 m    </span>
<span class="sd">    compress_LR                            boolean map as mask map for compressing lake/reservoir                  --   </span>
<span class="sd">    decompress_LR                          boolean map as mask map for decompressing lake/reservoir                --   </span>
<span class="sd">    waterBodyID_C                                                                                                  --   </span>
<span class="sd">    resYearC                               Compressed map of resYear                                               --   </span>
<span class="sd">    waterBodyTyp_unchanged                                                                                         --   </span>
<span class="sd">    resVolumeC                             compressed map of reservoir volume                                      Milli</span>
<span class="sd">    resId_restricted                                                                                               --   </span>
<span class="sd">    waterBodyBuffer                                                                                                --   </span>
<span class="sd">    waterBodyBuffer_wwt                                                                                            --   </span>
<span class="sd">    reservoir_transfers_net_M3             net reservoir transfers, after exports, transfers, and imports          m3   </span>
<span class="sd">    reservoir_transfers_in_M3              water received into reservoirs                                          m3   </span>
<span class="sd">    reservoir_transfers_out_M3             water given from reservoirs                                             m3   </span>
<span class="sd">    reservoir_transfers_from_outside_M3    water received into reservoirs from Outside                             m3   </span>
<span class="sd">    reservoir_transfers_to_outside_M3      water given from reservoirs to the Outside                              m3   </span>
<span class="sd">    MtoM3C                                 conversion factor from m to m3 (compressed map)                         --   </span>
<span class="sd">    waterBodyTypCTemp                                                                                              --   </span>
<span class="sd">    pot_livestockConsumption                                                                                       --   </span>
<span class="sd">    cellArea                               Area of cell                                                            m2   </span>
<span class="sd">    MtoM3                                  Coefficient to change units                                             --   </span>
<span class="sd">    InvDtSec                                                                                                       --   </span>
<span class="sd">    InvCellArea                            Inverse of cell area of each simulated mesh                             1/m2 </span>
<span class="sd">    M3toM                                  Coefficient to change units                                             --   </span>
<span class="sd">    GW_pumping                             Input, True if Groundwater_pumping=True                                 bool </span>
<span class="sd">    availableGWStorageFraction                                                                                     --   </span>
<span class="sd">    groundwater_storage_available          Groundwater storage. Used with MODFLOW.                                 m    </span>
<span class="sd">    gwstorage_full                         Groundwater storage at full capacity                                    m    </span>
<span class="sd">    wwtColArea                                                                                                     --   </span>
<span class="sd">    wwtSewerCollection                                                                                             --   </span>
<span class="sd">    wwtOverflowOutM                                                                                                --   </span>
<span class="sd">    fracVegCover                           Fraction of specific land covers (0=forest, 1=grasslands, etc.)         %    </span>
<span class="sd">    adminSegments                          Domestic agents                                                         Int  </span>
<span class="sd">    nonFossilGroundwaterAbs                Non-fossil groundwater abstraction. Used primarily without MODFLOW.     m    </span>
<span class="sd">    includeWastewater                                                                                              --   </span>
<span class="sd">    reservoir_transfers_net_M3C                                                                                    --   </span>
<span class="sd">    reservoir_transfers_in_M3C                                                                                     --   </span>
<span class="sd">    reservoir_transfers_out_M3C                                                                                    --   </span>
<span class="sd">    reservoir_transfers_from_outside_M3C                                                                           --   </span>
<span class="sd">    reservoir_transfers_to_outside_M3C                                                                             --   </span>
<span class="sd">    lakeVolumeM3C                          compressed map of lake volume                                           m3   </span>
<span class="sd">    lakeStorageC                                                                                                   --   </span>
<span class="sd">    reservoirStorageM3C                                                                                            --   </span>
<span class="sd">    lakeResStorageC                                                                                                --   </span>
<span class="sd">    lakeResStorage                                                                                                 --   </span>
<span class="sd">    smalllakeVolumeM3                                                                                              --   </span>
<span class="sd">    smalllakeStorage                                                                                               --   </span>
<span class="sd">    act_SurfaceWaterAbstract               Surface water abstractions                                              m    </span>
<span class="sd">    readAvlChannelStorageM                                                                                         --   </span>
<span class="sd">    leakageCanals_M                                                                                                --   </span>
<span class="sd">    addtoevapotrans                        Irrigation application loss to evaporation                              m    </span>
<span class="sd">    act_irrWithdrawal                      Irrigation withdrawals                                                  m    </span>
<span class="sd">    act_nonIrrConsumption                  Non-irrigation consumption                                              m    </span>
<span class="sd">    returnFlow                                                                                                     --   </span>
<span class="sd">    act_irrConsumption                     actual irrigation water consumption                                     m    </span>
<span class="sd">    act_irrNonpaddyWithdrawal              non-paddy irrigation withdrawal                                         m    </span>
<span class="sd">    act_irrPaddyWithdrawal                 paddy irrigation withdrawal                                             m    </span>
<span class="sd">    unmetDemand                            Unmet groundwater demand to determine potential fossil groundwaterwate  m    </span>
<span class="sd">    act_nonIrrWithdrawal                   Non-irrigation withdrawals                                              m    </span>
<span class="sd">    returnflowIrr                                                                                                  --   </span>
<span class="sd">    nonIrrReturnFlowFraction                                                                                       --   </span>
<span class="sd">    unmet_lost                             Fossil water that disappears instead of becoming return flow            m    </span>
<span class="sd">    channelStorage                         Channel water storage                                                   m3   </span>
<span class="sd">    act_totalWaterWithdrawal               Total water withdrawals                                                 m    </span>
<span class="sd">    act_bigLakeResAbst                     Abstractions to satisfy demands from lakes and reservoirs               m    </span>
<span class="sd">    act_smallLakeResAbst                   Abstractions from small lakes at demand location                        m    </span>
<span class="sd">    waterdemandFixed                                                                                               --   </span>
<span class="sd">    modfPumpingM                                                                                                   --   </span>
<span class="sd">    activate_domestic_agents               Input, True if activate_domestic_agents = True                          bool </span>
<span class="sd">    domesticDemand                         Domestic demand                                                         m    </span>
<span class="sd">    swAbstractionFraction_domestic         With domestic agents, derived from surface water over total water requ  %    </span>
<span class="sd">    demand_unit                                                                                                    --   </span>
<span class="sd">    pot_domesticConsumption                                                                                        --   </span>
<span class="sd">    sectorSourceAbstractionFractions                                                                               --   </span>
<span class="sd">    swAbstractionFraction_Channel_Domesti  Input, Fraction of Domestic demands to be satisfied with Channel        %    </span>
<span class="sd">    swAbstractionFraction_Lift_Domestic    Input, Fraction of Domestic demands to be satisfied with Lift           %    </span>
<span class="sd">    swAbstractionFraction_Res_Domestic     Input, Fraction of Domestic demands to be satisfied with Reservoirs     %    </span>
<span class="sd">    swAbstractionFraction_Lake_Domestic    Input, Fraction of Domestic demands to be satisfied with Lake           %    </span>
<span class="sd">    gwAbstractionFraction_Domestic         Fraction of domestic water demand to be satisfied by groundwater        %    </span>
<span class="sd">    dom_efficiency                                                                                                 --   </span>
<span class="sd">    envFlow                                                                                                        --   </span>
<span class="sd">    industryDemand                                                                                                 --   </span>
<span class="sd">    pot_industryConsumption                                                                                        --   </span>
<span class="sd">    ind_efficiency                                                                                                 --   </span>
<span class="sd">    unmetDemandPaddy                       Unmet paddy demand                                                      m    </span>
<span class="sd">    unmetDemandNonpaddy                    Unmet nonpaddy demand                                                   m    </span>
<span class="sd">    irrDemand                              Cover-specific Irrigation demand                                        m/m  </span>
<span class="sd">    irrNonpaddyDemand                                                                                              --   </span>
<span class="sd">    totalIrrDemand                         Irrigation demand                                                       m    </span>
<span class="sd">    livestockDemand                                                                                                --   </span>
<span class="sd">    liv_efficiency                                                                                                 --   </span>
<span class="sd">    wwtEffluentsGenerated                                                                                          --   </span>
<span class="sd">    wwtSewerCollection_domestic                                                                                    --   </span>
<span class="sd">    wwtSewerCollection_industry                                                                                    --   </span>
<span class="sd">    includeIndusDomesDemand                Input, True if includeIndusDomesDemand = True                           bool </span>
<span class="sd">    activate_irrigation_agents             Input, True if activate_irrigation_agents = True                        bool </span>
<span class="sd">    relaxGWagent                                                                                                   --   </span>
<span class="sd">    relaxSWagent                                                                                                   --   </span>
<span class="sd">    irrWithdrawalSW_max                                                                                            --   </span>
<span class="sd">    irrWithdrawalGW_max                                                                                            --   </span>
<span class="sd">    relax_irrigation_agents                                                                                        --   </span>
<span class="sd">    relax_abstraction_fraction_initial                                                                             --   </span>
<span class="sd">    waterdemandFixedYear                                                                                           --   </span>
<span class="sd">    swAbstractionFraction_Channel_Livesto  Input, Fraction of Livestock demands to be satisfied from Channels      %    </span>
<span class="sd">    swAbstractionFraction_Channel_Industr  Input, Fraction of Industrial water demand to be satisfied by Channels  %    </span>
<span class="sd">    swAbstractionFraction_Channel_Irrigat  Input, Fraction of Irrigation demand to be satisfied from Channels      %    </span>
<span class="sd">    swAbstractionFraction_Lake_Livestock   Input, Fraction of Livestock water demands to be satisfied by Lakes     %    </span>
<span class="sd">    swAbstractionFraction_Lake_Industry    Input, Fraction of Industrial water demand to be satisfied by Lakes     %    </span>
<span class="sd">    swAbstractionFraction_Lake_Irrigation  Input, Fraction of Irrigation demand to be satisfied by Lakes           %    </span>
<span class="sd">    swAbstractionFraction_Res_Livestock    Input, Fraction of Livestock water demands to be satisfied by Reservoi  %    </span>
<span class="sd">    swAbstractionFraction_Res_Industry     Input, Fraction of Industrial water demand to be satisfied by Reservoi  %    </span>
<span class="sd">    swAbstractionFraction_Res_Irrigation   Input, Fraction of Irrigation demand to be satisfied by Reservoirs      %    </span>
<span class="sd">    othAbstractionFraction_Desal_Domestic                                                                          --   </span>
<span class="sd">    othAbstractionFraction_Desal_Livestoc                                                                          --   </span>
<span class="sd">    othAbstractionFraction_Desal_Industry                                                                          --   </span>
<span class="sd">    othAbstractionFraction_Desal_Irrigati                                                                          --   </span>
<span class="sd">    wwtAbstractionFraction_Res_Domestic                                                                            --   </span>
<span class="sd">    wwtAbstractionFraction_Res_Livestock                                                                           --   </span>
<span class="sd">    wwtAbstractionFraction_Res_Industry                                                                            --   </span>
<span class="sd">    wwtAbstractionFraction_Res_Irrigation                                                                          --   </span>
<span class="sd">    gwAbstractionFraction_Livestock        Fraction of livestock water demand to be satisfied by groundwater       %    </span>
<span class="sd">    gwAbstractionFraction_Industry         Fraction of industrial water demand to be satisfied by groundwater      %    </span>
<span class="sd">    gwAbstractionFraction_Irrigation       Fraction of irrigation water demand to be satisfied by groundwater      %    </span>
<span class="sd">    using_reservoir_command_areas          True if using_reservoir_command_areas = True, False otherwise           bool </span>
<span class="sd">    load_command_areas                                                                                             --   </span>
<span class="sd">    load_command_areas_wwt                                                                                         --   </span>
<span class="sd">    reservoir_command_areas                                                                                        --   </span>
<span class="sd">    reservoir_command_areas_wwt                                                                                    --   </span>
<span class="sd">    Water_conveyance_efficiency                                                                                    --   </span>
<span class="sd">    segmentArea                                                                                                    --   </span>
<span class="sd">    segmentArea_wwt                                                                                                --   </span>
<span class="sd">    canals                                                                                                         --   </span>
<span class="sd">    canals_wwt                                                                                                     --   </span>
<span class="sd">    canalsArea                                                                                                     --   </span>
<span class="sd">    canalsAreaC                                                                                                    --   </span>
<span class="sd">    canalsArea_wwt                                                                                                 --   </span>
<span class="sd">    canalsArea_wwtC                                                                                                --   </span>
<span class="sd">    swAbstractionFraction_Lift_Livestock   Input, Fraction of Livestock water demands to be satisfied from Lift a  %    </span>
<span class="sd">    swAbstractionFraction_Lift_Industry    Input, Fraction of Industrial water demand to be satisfied from Lift a  %    </span>
<span class="sd">    swAbstractionFraction_Lift_Irrigation  Input, Fraction of Irrigation demand to be satisfied from Lift areas    %    </span>
<span class="sd">    using_lift_areas                       True if using_lift_areas = True in Settings, False otherwise            bool </span>
<span class="sd">    lift_command_areas                                                                                             --   </span>
<span class="sd">    allocSegments                                                                                                  --   </span>
<span class="sd">    swAbstractionFraction                  Input, Fraction of demands to be satisfied with surface water           %    </span>
<span class="sd">    allocation_zone                                                                                                --   </span>
<span class="sd">    modflowPumping                                                                                                 --   </span>
<span class="sd">    leakage                                Canal leakage leading to either groundwater recharge or runoff          m3   </span>
<span class="sd">    pumping                                                                                                        --   </span>
<span class="sd">    Pumping_daily                          Groundwater abstraction asked of MODFLOW. modfPumpingM_actual is the r  m    </span>
<span class="sd">    modflowDepth2                                                                                                  --   </span>
<span class="sd">    modflowTopography                                                                                              --   </span>
<span class="sd">    allowedPumping                                                                                                 --   </span>
<span class="sd">    ratio_irrWithdrawalGW_month                                                                                    --   </span>
<span class="sd">    ratio_irrWithdrawalSW_month                                                                                    --   </span>
<span class="sd">    act_irrWithdrawalSW_month              Running total agent surface water withdrawals for the month             m    </span>
<span class="sd">    act_irrWithdrawalGW_month              Running total agent groundwater withdrawals for the month               m    </span>
<span class="sd">    Desal_Domestic                                                                                                 --   </span>
<span class="sd">    Desal_Industry                                                                                                 --   </span>
<span class="sd">    Desal_Livestock                                                                                                --   </span>
<span class="sd">    Desal_Irrigation                                                                                               --   </span>
<span class="sd">    Channel_Domestic                       Channel water abstracted for domestic                                   m    </span>
<span class="sd">    Channel_Industry                       Channel water abstracted for industry                                   m    </span>
<span class="sd">    Channel_Livestock                      Channel water abstracted for livestock                                  m    </span>
<span class="sd">    Channel_Irrigation                     Channel water abstracted for irrigation                                 m    </span>
<span class="sd">    Lift_Domestic                                                                                                  --   </span>
<span class="sd">    Lift_Industry                                                                                                  --   </span>
<span class="sd">    Lift_Livestock                                                                                                 --   </span>
<span class="sd">    Lift_Irrigation                                                                                                --   </span>
<span class="sd">    wwt_Domestic                                                                                                   --   </span>
<span class="sd">    wwt_Industry                                                                                                   --   </span>
<span class="sd">    wwt_Livestock                                                                                                  --   </span>
<span class="sd">    wwt_Irrigation                                                                                                 --   </span>
<span class="sd">    Lake_Domestic                                                                                                  --   </span>
<span class="sd">    Lake_Industry                                                                                                  --   </span>
<span class="sd">    Lake_Livestock                                                                                                 --   </span>
<span class="sd">    Lake_Irrigation                                                                                                --   </span>
<span class="sd">    Res_Domestic                                                                                                   --   </span>
<span class="sd">    Res_Industry                                                                                                   --   </span>
<span class="sd">    Res_Livestock                                                                                                  --   </span>
<span class="sd">    Res_Irrigation                                                                                                 --   </span>
<span class="sd">    GW_Domestic                            Groundwater withdrawals to satisfy domestic water requests              m    </span>
<span class="sd">    GW_Industry                            Groundwater withdrawals to satisfy Industrial water requests            m    </span>
<span class="sd">    GW_Livestock                           Groundwater withdrawals to satisfy Livestock water requests             m    </span>
<span class="sd">    GW_Irrigation                          Groundwater withdrawals for Irrigation                                  m    </span>
<span class="sd">    abstractedLakeReservoirM3              Abstractions from lakes and reservoirs at the location of the waterbod  m3   </span>
<span class="sd">    leakage_wwtC_daily                                                                                             --   </span>
<span class="sd">    act_bigLakeResAbst_wwt                                                                                         --   </span>
<span class="sd">    act_DesalWaterAbstractM                                                                                        --   </span>
<span class="sd">    act_totalIrrConsumption                Total irrigation consumption                                            m    </span>
<span class="sd">    act_totalWaterConsumption              Total water consumption                                                 m    </span>
<span class="sd">    act_indConsumption                     Industrial consumption                                                  m    </span>
<span class="sd">    act_domConsumption                     Domestic consumption                                                    m    </span>
<span class="sd">    act_livConsumption                     Livestock consumptions                                                  m    </span>
<span class="sd">    returnflowNonIrr                                                                                               --   </span>
<span class="sd">    nonIrruse                                                                                                      --   </span>
<span class="sd">    act_indDemand                          Industrial demand                                                       m    </span>
<span class="sd">    act_domDemand                          Domestic demand                                                         m    </span>
<span class="sd">    act_livDemand                          Livestock demands                                                       m    </span>
<span class="sd">    nonIrrDemand                                                                                                   --   </span>
<span class="sd">    totalWaterDemand                       Irrigation and non-irrigation demand                                    m    </span>
<span class="sd">    act_indWithdrawal                      Industrial withdrawal                                                   m    </span>
<span class="sd">    act_domWithdrawal                      Domestic withdrawal                                                     m    </span>
<span class="sd">    act_livWithdrawal                      Livestock withdrawals                                                   m    </span>
<span class="sd">    pot_GroundwaterAbstract                Potential groundwater abstraction. Primarily used without MODFLOW.      m    </span>
<span class="sd">    WB_elec                                Fractions of live storage to be exported from basin                     366-d</span>
<span class="sd">    act_nonpaddyConsumption                Non-paddy irrigation consumption                                        m    </span>
<span class="sd">    act_paddyConsumption                   Paddy consumption                                                       m    </span>
<span class="sd">    pot_nonIrrConsumption                                                                                          --   </span>
<span class="sd">    act_DesalWaterAbstractM3                                                                                       --   </span>
<span class="sd">    AvlDesalM3                                                                                                     --   </span>
<span class="sd">    act_channelAbst                        Abstractions to satisfy demands from channels                           m    </span>
<span class="sd">    metRemainSegment_lift                                                                                          --   </span>
<span class="sd">    act_channelAbstract_Lift               Abstractions from the channel in lift areas at the location of the cha  m    </span>
<span class="sd">    abstractedLakeReservoirM3C             Compressed abstractedLakeReservoirM3                                    m3   </span>
<span class="sd">    remainNeed                                                                                                     --   </span>
<span class="sd">    act_ResAbst_wwt                                                                                                --   </span>
<span class="sd">    act_lakeAbst                           Abstractions from lakes at demand location                              m    </span>
<span class="sd">    inZero_C                                                                                                       --   </span>
<span class="sd">    swAbstractionFraction_nonIrr           Input, Fraction of non-irrigation demands to be satisfied with surface  %    </span>
<span class="sd">    act_ResAbst                            Abstractions from reservoirs at demand location                         m    </span>
<span class="sd">    leakageC_daily                                                                                                 --   </span>
<span class="sd">    leakageCanalsC_M                                                                                               --   </span>
<span class="sd">    act_irrPaddyDemand                     paddy irrigation demand                                                 m    </span>
<span class="sd">    act_irrNonpaddyDemand                  non-paddy irrigation demand                                             m    </span>
<span class="sd">    Channel_Domestic_fromZone                                                                                      --   </span>
<span class="sd">    Channel_Livestock_fromZone                                                                                     --   </span>
<span class="sd">    Channel_Industry_fromZone                                                                                      --   </span>
<span class="sd">    Channel_Irrigation_fromZone                                                                                    --   </span>
<span class="sd">    GW_Domestic_fromZone                                                                                           --   </span>
<span class="sd">    GW_Livestock_fromZone                                                                                          --   </span>
<span class="sd">    GW_Industry_fromZone                                                                                           --   </span>
<span class="sd">    GW_Irrigation_fromZone                                                                                         --   </span>
<span class="sd">    PumpingM3_daily                                                                                                --   </span>
<span class="sd">    unmet_lostirr                          Fossil water for irrigation that disappears instead of becoming return  m    </span>
<span class="sd">    unmet_lostNonirr                       Fossil water for non-irrigation that disappears instead of becoming re  m    </span>
<span class="sd">    wwtEffluentsGenerated_domestic                                                                                 --   </span>
<span class="sd">    wwtEffluentsGenerated_industry                                                                                 --   </span>
<span class="sd">    wwtSewerCollectedBySoruce                                                                                      --   </span>
<span class="sd">    waterabstraction                                                                                               --   </span>
<span class="sd">    =====================================  ======================================================================  =====</span>

<span class="sd">    **Functions**</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">domestic</span> <span class="o">=</span> <span class="n">waterdemand_domestic</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">industry</span> <span class="o">=</span> <span class="n">waterdemand_industry</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">livestock</span> <span class="o">=</span> <span class="n">waterdemand_livestock</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">irrigation</span> <span class="o">=</span> <span class="n">waterdemand_irrigation</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environmental_need</span> <span class="o">=</span> <span class="n">waterdemand_environmental_need</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wastewater</span> <span class="o">=</span> <span class="n">waterdemand_wastewater</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

<div class="viewcode-block" id="water_demand.initial"><a class="viewcode-back" href="../../../../hydrological_modules.html#cwatm.hydrological_modules.water_demand.water_demand.water_demand.initial">[docs]</a>    <span class="k">def</span> <span class="nf">initial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initial part of the water demand module</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># True if all demands are taken into account,</span>
        <span class="c1"># False if not only irrigation is considered</span>
        <span class="c1"># This variable has no impact if includeWaterDemand is False</span>
        <span class="k">if</span> <span class="s2">&quot;includeIndusDomesDemand&quot;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span> <span class="o">=</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;includeIndusDomesDemand&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeWastewater</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;includeWastewater&quot;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeWastewater</span> <span class="o">=</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;includeWastewater&#39;</span><span class="p">)</span>

        <span class="c1"># Variables related to agents =========================</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">activate_domestic_agents</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;activate_domestic_agents&#39;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;activate_domestic_agents&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">activate_domestic_agents</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">activate_irrigation_agents</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;activate_irrigation_agents&#39;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;activate_irrigation_agents&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">activate_irrigation_agents</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxGWagent</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxSWagent</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrWithdrawalSW_max</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrWithdrawalGW_max</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relax_irrigation_agents</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;relax_irrigation_agents&#39;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;relax_irrigation_agents&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relax_irrigation_agents</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s1">&#39;adminSegments&#39;</span> <span class="ow">in</span> <span class="n">binding</span><span class="p">:</span>
            <span class="c1"># adminSegments (administrative segment) are collections of cells that are associated together, ie Agents</span>
            <span class="c1"># Cells within the same administrative segment have the same positive integer value.</span>
            <span class="c1"># Cells with non-positive integer values are all associated together.</span>
            <span class="c1"># Irrigation agents use adminSegments</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">adminSegments</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;adminSegments&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">adminSegments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">adminSegments</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">adminSegments</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;irrigation_agent_SW_request_month_m3&#39;</span> <span class="ow">in</span> <span class="n">binding</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">activate_irrigation_agents</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrWithdrawalSW_max</span> <span class="o">=</span> <span class="n">npareaaverage</span><span class="p">(</span>
                    <span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;irrigation_agent_SW_request_month_m3&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">adminSegments</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;relax_sw_agent&#39;</span> <span class="ow">in</span> <span class="n">binding</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">loadInit</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxSWagent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">load_initial</span><span class="p">(</span><span class="s1">&#39;relaxSWagent&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxSWagent</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;relax_sw_agent&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;irrigation_agent_GW_request_month_m3&#39;</span> <span class="ow">in</span> <span class="n">binding</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">activate_irrigation_agents</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrWithdrawalGW_max</span> <span class="o">=</span> <span class="n">npareaaverage</span><span class="p">(</span>
                    <span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;irrigation_agent_GW_request_month_m3&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">adminSegments</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;relax_gw_agent&#39;</span> <span class="ow">in</span> <span class="n">binding</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">loadInit</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxGWagent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">load_initial</span><span class="p">(</span><span class="s1">&#39;relaxGWagent&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxGWagent</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;relax_gw_agent&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;relax_abstraction_fraction_initial&#39;</span> <span class="ow">in</span> <span class="n">binding</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relax_abstraction_fraction_initial</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                    <span class="s1">&#39;relax_abstraction_fraction_initial&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relax_abstraction_fraction_initial</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeWastewaterPits</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;includePitLatrine&#39;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeWastewaterPits</span> <span class="o">=</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;includePitLatrine&#39;</span><span class="p">)</span>

        <span class="c1"># =======================================================</span>

        <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;includeWaterDemand&#39;</span><span class="p">):</span>



            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span><span class="p">:</span>  <span class="c1"># all demands are taken into account</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">domestic</span><span class="o">.</span><span class="n">initial</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">industry</span><span class="o">.</span><span class="n">initial</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">livestock</span><span class="o">.</span><span class="n">initial</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">irrigation</span><span class="o">.</span><span class="n">initial</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environmental_need</span><span class="o">.</span><span class="n">initial</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wastewater</span><span class="o">.</span><span class="n">initial</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># only irrigation is considered</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">irrigation</span><span class="o">.</span><span class="n">initial</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environmental_need</span><span class="o">.</span><span class="n">initial</span><span class="p">()</span>

            <span class="c1"># if waterdemand is fixed it means it does not change between years.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterdemandFixed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s2">&quot;waterdemandFixed&quot;</span> <span class="ow">in</span> <span class="n">binding</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">returnBool</span><span class="p">(</span><span class="s1">&#39;waterdemandFixed&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterdemandFixed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterdemandFixedYear</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;waterdemandFixedYear&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Sector-,source-abstraction fractions facilitate designating the specific source for the specific sector</span>
            <span class="c1"># Sources: River, Lake, Reservoir, Groundwater</span>
            <span class="c1"># Sectors: Domestic, Industry, Livestock, Irrigation</span>
            <span class="c1"># Otherwise, one can distinguish only between surface and groundwater, irrigation and non-irrigation</span>

            <span class="k">if</span> <span class="s1">&#39;sectorSourceAbstractionFractions&#39;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;sectorSourceAbstractionFractions&#39;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sector- and source-specific abstraction fractions are activated (water_demand.py)&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Channel_Domestic</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                        <span class="s1">&#39;swAbstractionFraction_Channel_Domestic&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Channel_Livestock</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                        <span class="s1">&#39;swAbstractionFraction_Channel_Livestock&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Channel_Industry</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                        <span class="s1">&#39;swAbstractionFraction_Channel_Industry&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Channel_Irrigation</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                        <span class="s1">&#39;swAbstractionFraction_Channel_Irrigation&#39;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lake_Domestic</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                        <span class="s1">&#39;swAbstractionFraction_Lake_Domestic&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lake_Livestock</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                        <span class="s1">&#39;swAbstractionFraction_Lake_Livestock&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lake_Industry</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                        <span class="s1">&#39;swAbstractionFraction_Lake_Industry&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lake_Irrigation</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                        <span class="s1">&#39;swAbstractionFraction_Lake_Irrigation&#39;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Res_Domestic</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                        <span class="s1">&#39;swAbstractionFraction_Res_Domestic&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Res_Livestock</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                        <span class="s1">&#39;swAbstractionFraction_Res_Livestock&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Res_Industry</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                        <span class="s1">&#39;swAbstractionFraction_Res_Industry&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Res_Irrigation</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                        <span class="s1">&#39;swAbstractionFraction_Res_Irrigation&#39;</span><span class="p">)</span>
                        
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeDesal</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">othAbstractionFraction_Desal_Domestic</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;othAbstractionFraction_Desal_Domestic&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">othAbstractionFraction_Desal_Livestock</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;othAbstractionFraction_Desal_Livestock&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">othAbstractionFraction_Desal_Industry</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;othAbstractionFraction_Desal_Industry&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">othAbstractionFraction_Desal_Irrigation</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;othAbstractionFraction_Desal_Irrigation&#39;</span><span class="p">)</span>
                            
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeWastewater</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtAbstractionFraction_Res_Domestic</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;wwtAbstractionFraction_Res_Domestic&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtAbstractionFraction_Res_Livestock</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;wwtAbstractionFraction_Res_Livestock&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtAbstractionFraction_Res_Industry</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;wwtAbstractionFraction_Res_Industry&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtAbstractionFraction_Res_Irrigation</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;wwtAbstractionFraction_Res_Irrigation&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;limitAbstraction&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Domestic</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Livestock</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Industry</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Irrigation</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Domestic</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;gwAbstractionFraction_Domestic&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Livestock</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;gwAbstractionFraction_Livestock&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Industry</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;gwAbstractionFraction_Industry&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Irrigation</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;gwAbstractionFraction_Irrigation&#39;</span><span class="p">)</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">using_reservoir_command_areas</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">load_command_areas</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">load_command_areas_wwt</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="k">if</span> <span class="s1">&#39;using_reservoir_command_areas&#39;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;using_reservoir_command_areas&#39;</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;includeWaterBodies&#39;</span><span class="p">):</span>
                    
                    <span class="c1"># initiate reservoir_command_areas &amp; reservoir_command_areas_wwt</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    
                    <span class="k">if</span> <span class="s1">&#39;reservoir_command_areas&#39;</span> <span class="ow">in</span> <span class="n">binding</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">load_command_areas</span> <span class="o">=</span> <span class="kc">True</span>
                    
                    <span class="k">if</span> <span class="s1">&#39;reservoir_command_areas_restricted&#39;</span> <span class="ow">in</span> <span class="n">binding</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">load_command_areas_wwt</span> <span class="o">=</span> <span class="kc">True</span>
                        
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">modflow</span> <span class="ow">and</span> <span class="s1">&#39;Water_conveyance_efficiency&#39;</span> <span class="ow">in</span> <span class="n">binding</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Water_conveyance_efficiency</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;Water_conveyance_efficiency&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Water_conveyance_efficiency</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span>

                    <span class="c1"># load command areas &amp; command areas_wwt</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">load_command_areas</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;reservoir_command_areas&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

                        <span class="c1"># Lakes/restricted reservoirs within command areas are removed from the command area</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyTyp_unchanged</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
                                                                <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">resId_restricted</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">segmentArea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                        <span class="n">npareatotal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">,</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">load_command_areas_wwt</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;reservoir_command_areas_restricted&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                        <span class="c1"># Lakes &amp; all non-restricted res. within command areas are removed from the command area</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyTyp_unchanged</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
                                                                    <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">resId_restricted</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyTyp_unchanged</span> <span class="o">==</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">segmentArea_wwt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                        <span class="n">npareatotal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">,</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">)</span>
                    <span class="c1"># Water abstracted from reservoirs leaks along canals related to conveyance efficiency.</span>
                    <span class="c1"># Canals are a map where canal cells have the number of the command area they are associated with</span>
                    <span class="c1"># Command areas without canals experience leakage equally throughout the command area</span>

                    <span class="k">if</span> <span class="s1">&#39;canals&#39;</span> <span class="ow">in</span> <span class="n">binding</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;canals&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals_wwt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals_wwt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">load_command_areas</span><span class="p">:</span>
                        <span class="c1"># canals for potable water </span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals</span><span class="p">)</span>

                        <span class="c1"># When there are no set canals, the entire command area expereinces leakage</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">npareamaximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canalsArea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npareatotal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals</span><span class="p">),</span>
                                                    <span class="mi">0</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canalsAreaC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canalsArea</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">load_command_areas_wwt</span><span class="p">:</span>
                        <span class="c1"># canals for wwt reclaimed water </span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals_wwt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals_wwt</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals_wwt</span><span class="p">)</span>
                        
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals_wwt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">npareamaximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals_wwt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals_wwt</span><span class="p">)</span>
                                               
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canalsArea_wwt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals_wwt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">npareatotal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals_wwt</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canalsArea_wwtC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canalsArea_wwt</span><span class="p">)</span>
                    
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lift_Domestic</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lift_Livestock</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lift_Industry</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lift_Irrigation</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">using_lift_areas</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s1">&#39;using_lift_areas&#39;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;using_lift_areas&#39;</span><span class="p">):</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">using_lift_areas</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lift_command_areas</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;lift_areas&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lift_Domestic</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;swAbstractionFraction_Lift_Domestic&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lift_Livestock</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;swAbstractionFraction_Lift_Livestock&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lift_Industry</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;swAbstractionFraction_Lift_Industry&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lift_Irrigation</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;swAbstractionFraction_Lift_Irrigation&#39;</span><span class="p">)</span>

            <span class="c1"># -------------------------------------------</span>
            <span class="c1"># partitioningGroundSurfaceAbstraction</span>
            <span class="c1"># partitioning abstraction sources: groundwater and surface water</span>
            <span class="c1"># partitioning based on local average baseflow (m3/s) and upstream average discharge (m3/s)</span>
            <span class="c1"># estimates of fractions of groundwater and surface water abstractions</span>
            <span class="n">swAbstractionFraction</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;swAbstractionFrac&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">swAbstractionFraction</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>

                <span class="n">averageBaseflowInput</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;averageBaseflow&#39;</span><span class="p">)</span>
                <span class="n">averageDischargeInput</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;averageDischarge&#39;</span><span class="p">)</span>
                <span class="c1"># convert baseflow from m to m3/s</span>
                <span class="k">if</span> <span class="n">returnBool</span><span class="p">(</span><span class="s1">&#39;baseflowInM&#39;</span><span class="p">):</span>
                    <span class="n">averageBaseflowInput</span> <span class="o">=</span> <span class="n">averageBaseflowInput</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">InvDtSec</span>

                <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;usingAllocSegments&#39;</span><span class="p">):</span>
                    <span class="n">averageBaseflowInput</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">allocSegments</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                    <span class="n">npareaaverage</span><span class="p">(</span><span class="n">averageBaseflowInput</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">allocSegments</span><span class="p">),</span>
                                                    <span class="n">averageBaseflowInput</span><span class="p">)</span>

                    <span class="c1"># averageUpstreamInput = np.where(self.var.allocSegments &gt; 0,</span>
                    <span class="c1">#                                npareamaximum(averageDischargeInput, self.var.allocSegments),</span>
                    <span class="c1">#                                averageDischargeInput)</span>

                <span class="n">swAbstractionFraction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">averageDischargeInput</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1e-20</span><span class="p">,</span>
                                                                                                           <span class="n">averageDischargeInput</span> <span class="o">+</span> <span class="n">averageBaseflowInput</span><span class="p">)))</span>
                <span class="n">swAbstractionFraction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">swAbstractionFraction</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">No</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="n">No</span><span class="p">]</span> <span class="o">*</span> <span class="n">swAbstractionFraction</span>
            <span class="k">for</span> <span class="n">No</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">modflow</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="n">No</span><span class="p">]</span> <span class="o">*</span> <span class="n">swAbstractionFraction</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># The motivation is to avoid groundwater on sealed and water land classes</span>
                    <span class="c1"># TODO: Groundwater pumping should be allowed over sealed land</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="n">No</span><span class="p">]</span>

            <span class="c1"># non-irrigation input maps have for each month or year the unit m/day (True) or million m3/month (False)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">demand_unit</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s2">&quot;demand_unit&quot;</span> <span class="ow">in</span> <span class="n">binding</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">demand_unit</span> <span class="o">=</span> <span class="n">returnBool</span><span class="p">(</span><span class="s1">&#39;demand_unit&#39;</span><span class="p">)</span>

            <span class="c1"># allocation zone</span>
            <span class="c1"># regular grid inside the 2d array</span>
            <span class="c1"># inner grid size</span>
            <span class="n">inner</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="s2">&quot;allocation_area&quot;</span> <span class="ow">in</span> <span class="n">binding</span><span class="p">:</span>
                <span class="n">inner</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;allocation_area&#39;</span><span class="p">))</span>

            <span class="n">latldd</span><span class="p">,</span> <span class="n">lonldd</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">invcellldd</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">readCoord</span><span class="p">(</span><span class="n">cbinding</span><span class="p">(</span><span class="s1">&#39;Ldd&#39;</span><span class="p">))</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">cbinding</span><span class="p">(</span><span class="s1">&#39;Ldd&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="n">cut0</span><span class="p">,</span> <span class="n">cut1</span><span class="p">,</span> <span class="n">cut2</span><span class="p">,</span> <span class="n">cut3</span> <span class="o">=</span> <span class="n">mapattrNetCDF</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">cbinding</span><span class="p">(</span><span class="s1">&#39;Ldd&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span>

                <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)):</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">cbinding</span><span class="p">(</span><span class="s1">&#39;Ldd&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.map&#39;</span>
                    
                <span class="n">nf2</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">gdalconst</span><span class="o">.</span><span class="n">GA_ReadOnly</span><span class="p">)</span>
                <span class="n">cut0</span><span class="p">,</span> <span class="n">cut1</span><span class="p">,</span> <span class="n">cut2</span><span class="p">,</span> <span class="n">cut3</span> <span class="o">=</span> <span class="n">mapattrTiff</span><span class="p">(</span><span class="n">nf2</span><span class="p">)</span>

            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">rows</span> <span class="o">//</span> <span class="n">inner</span> <span class="o">*</span> <span class="n">cols</span> <span class="o">//</span> <span class="n">inner</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">rows</span> <span class="o">//</span> <span class="n">inner</span><span class="p">,</span> <span class="n">cols</span> <span class="o">//</span> <span class="n">inner</span><span class="p">)),</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">inner</span><span class="p">,</span> <span class="n">inner</span><span class="p">)))</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">cut2</span><span class="p">:</span><span class="n">cut3</span><span class="p">,</span> <span class="n">cut0</span><span class="p">:</span><span class="n">cut1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">allocation_zone</span> <span class="o">=</span> <span class="n">compressArray</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">modflowPumping</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakage</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pumping</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">modfPumpingM</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Pumping_daily</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">modflowDepth2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">modflowTopography</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">allowedPumping</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakageCanals_M</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrWithdrawal</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ratio_irrWithdrawalGW_month</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ratio_irrWithdrawalSW_month</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawalSW_month</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawalGW_month</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Domestic</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Industry</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Livestock</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Irrigation</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Industry</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Irrigation</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Domestic</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Industry</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Livestock</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Irrigation</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Domestic</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Industry</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Livestock</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Irrigation</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Domestic</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Industry</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Livestock</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Irrigation</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Domestic</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Industry</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Livestock</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Irrigation</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Domestic</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Industry</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Livestock</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Irrigation</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">abstractedLakeReservoirM3</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_domestic</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ind_efficiency</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">dom_efficiency</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">liv_efficiency</span> <span class="o">=</span> <span class="mi">1</span>
 
            <span class="c1"># for wastewater package</span>
            <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;includeWaterBodies&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakage_wwtC_daily</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst_wwt</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_DesalWaterAbstractM</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrConsumption</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalIrrConsumption</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalWaterConsumption</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_indConsumption</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_domConsumption</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_livConsumption</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowIrr</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pitLatrinToGW</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># no water demand</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrReturnFlowFraction</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrruse</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_indDemand</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_domDemand</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_livDemand</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrDemand</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalWaterDemand</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawal</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrWithdrawal</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalWaterWithdrawal</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_indConsumption</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_domConsumption</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_livConsumption</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_indWithdrawal</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_domWithdrawal</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_livWithdrawal</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalIrrConsumption</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalWaterConsumption</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemand</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">addtoevapotrans</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowIrr</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnFlow</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemandPaddy</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemandNonpaddy</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ind_efficiency</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">dom_efficiency</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">liv_efficiency</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">modflowPumping</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">modflowDepth2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">modflowTopography</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst_wwt</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakage</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pumping</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmet_lost</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_GroundwaterAbstract</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakageCanals_M</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">WB_elec</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxSWagent</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxGWagent</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Domestic</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Industry</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Livestock</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Irrigation</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Industry</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Irrigation</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Domestic</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Industry</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Livestock</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Irrigation</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Domestic</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Industry</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Livestock</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Irrigation</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Domestic</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Industry</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Livestock</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Irrigation</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">abstractedLakeReservoirM3</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_domestic</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonpaddyConsumption</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_paddyConsumption</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># for wastewater package</span>
            <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;includeWaterBodies&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakage_wwtC_daily</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst_wwt</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_DesalWaterAbstractM</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrConsumption</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>


<div class="viewcode-block" id="water_demand.dynamic"><a class="viewcode-back" href="../../../../hydrological_modules.html#cwatm.hydrological_modules.water_demand.water_demand.water_demand.dynamic">[docs]</a>    <span class="k">def</span> <span class="nf">dynamic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dynamic part of the water demand module</span>

<span class="sd">        * calculate the fraction of water from surface water vs. groundwater</span>
<span class="sd">        * get non-Irrigation water demand and its return flow fraction</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">modflow</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span><span class="p">:</span>  <span class="c1"># all demands are taken into account</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environmental_need</span><span class="o">.</span><span class="n">dynamic</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">envFlow</span> <span class="o">=</span> <span class="mf">0.00001</span>  <span class="c1"># 0.01mm</span>

            <span class="c1"># computing leakage from rivers to groundwater</span>

            <span class="c1"># self.var.readAvlChannelStorageM will be used in land covertype to compute leakage to groundwater if ModFlow coupling</span>
            <span class="c1"># to avoid small values and to avoid surface water abstractions from dry channels (&gt;= 0.01mm)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlChannelStorageM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">channelStorage</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mf">0.0005</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">),</span> <span class="mf">0.</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">channelStorage</span><span class="p">)</span>  <span class="c1"># in [m3]</span>
            <span class="c1"># coversersion m3 -&gt; m # minus environmental flow</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlChannelStorageM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlChannelStorageM</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">M3toM</span>  <span class="c1"># in [m]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlChannelStorageM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlChannelStorageM</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">envFlow</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;includeWaterDemand&#39;</span><span class="p">):</span>

            <span class="c1"># for debugging of a specific date</span>
            <span class="c1"># if (globals.dateVar[&#39;curr&#39;] &gt;= 137):</span>
            <span class="c1">#    ii =1</span>

            <span class="c1"># ----------------------------------------------------</span>
            <span class="c1"># WATER DEMAND</span>

            <span class="c1"># Fix year of water demand on predefined year</span>
            <span class="n">wd_date</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">dateVar</span><span class="p">[</span><span class="s1">&#39;currDate&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterdemandFixed</span><span class="p">:</span>
                <span class="n">wd_date</span> <span class="o">=</span> <span class="n">wd_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">wd_date</span> <span class="o">=</span> <span class="n">wd_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterdemandFixedYear</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span><span class="p">:</span>  <span class="c1"># all demands are taken into account</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">domestic</span><span class="o">.</span><span class="n">dynamic</span><span class="p">(</span><span class="n">wd_date</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">industry</span><span class="o">.</span><span class="n">dynamic</span><span class="p">(</span><span class="n">wd_date</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">livestock</span><span class="o">.</span><span class="n">dynamic</span><span class="p">(</span><span class="n">wd_date</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">irrigation</span><span class="o">.</span><span class="n">dynamic</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environmental_need</span><span class="o">.</span><span class="n">dynamic</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">irrigation</span><span class="o">.</span><span class="n">dynamic</span><span class="p">()</span>
                <span class="c1"># if not self.var.modflow:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environmental_need</span><span class="o">.</span><span class="n">dynamic</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span><span class="p">:</span>  <span class="c1"># all demands are taken into account</span>
                <span class="k">if</span> <span class="nb">globals</span><span class="o">.</span><span class="n">dateVar</span><span class="p">[</span><span class="s1">&#39;newStart&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">globals</span><span class="o">.</span><span class="n">dateVar</span><span class="p">[</span><span class="s1">&#39;newMonth&#39;</span><span class="p">]</span> \
                        <span class="ow">or</span> <span class="s1">&#39;basin_transfers_daily_operations&#39;</span> <span class="ow">in</span> <span class="n">option</span> <span class="ow">or</span> <span class="s1">&#39;reservoir_transfers&#39;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
                    <span class="c1"># total (potential) non irrigation water demand</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrDemand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_nonIrrConsumption</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrDemand</span><span class="p">,</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_domesticConsumption</span> <span class="o">+</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_industryConsumption</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_livestockConsumption</span><span class="p">)</span>
                    <span class="c1"># fraction of return flow from domestic and industrial water demand</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrReturnFlowFraction</span> <span class="o">=</span> <span class="n">divideValues</span><span class="p">(</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_nonIrrConsumption</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrDemand</span><span class="p">)</span>

                <span class="c1"># non-irrg fracs in nonIrrDemand</span>
                <span class="n">frac_industry</span> <span class="o">=</span> <span class="n">divideValues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrDemand</span><span class="p">)</span>
                <span class="n">frac_domestic</span> <span class="o">=</span> <span class="n">divideValues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrDemand</span><span class="p">)</span>
                <span class="n">frac_livestock</span> <span class="o">=</span> <span class="n">divideValues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrDemand</span><span class="p">)</span>

                <span class="c1"># Sum up water demand</span>
                <span class="c1"># totalDemand [m]: total maximum (potential) water demand: irrigation and non irrigation</span>
                <span class="n">totalDemand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrDemand</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span>  <span class="c1"># in [m]</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># only irrigation is considered</span>
                <span class="n">totalDemand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span><span class="p">)</span>  <span class="c1"># in [m]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrDemand</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_nonIrrConsumption</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrReturnFlowFraction</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">frac_industry</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">frac_domestic</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">frac_livestock</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="c1"># print(&#39;-----------------------------totalDemand---------: &#39;, np.mean(totalDemand))</span>

            <span class="c1"># ----------------------------------------------------</span>
            <span class="c1"># WATER AVAILABILITY</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">modflow</span><span class="p">:</span>  <span class="c1"># already done if ModFlow coupling</span>
                <span class="c1"># conversion m3 -&gt; m # minus environmental flow</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlChannelStorageM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">channelStorage</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">M3toM</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">envFlow</span><span class="p">)</span>  <span class="c1"># in [m]</span>

            <span class="c1"># -------------------------------------</span>
            <span class="c1"># WATER DEMAND vs. WATER AVAILABILITY</span>
            <span class="c1"># -------------------------------------</span>

            <span class="k">if</span> <span class="n">dateVar</span><span class="p">[</span><span class="s1">&#39;newStart&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">dateVar</span><span class="p">[</span><span class="s1">&#39;newMonth&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawalSW_month</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawalGW_month</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="k">if</span> <span class="s1">&#39;irrigation_agent_SW_request_month_m3&#39;</span> <span class="ow">in</span> <span class="n">binding</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">activate_irrigation_agents</span><span class="p">:</span>

                    <span class="c1"># These are read at the beginning of each month as they are updated by several relax functions</span>
                    <span class="c1"># and turned off once satisfying request</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Channel_Irrigation</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;swAbstractionFraction_Channel_Irrigation&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">using_lift_areas</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lift_Irrigation</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                                <span class="s1">&#39;swAbstractionFraction_Lift_Irrigation&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lake_Irrigation</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;swAbstractionFraction_Lake_Irrigation&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Res_Irrigation</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;swAbstractionFraction_Res_Irrigation&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Channel_Irrigation</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">using_lift_areas</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lift_Irrigation</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lake_Irrigation</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Res_Irrigation</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relax_irrigation_agents</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Channel_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxSWagent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                                                     <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relax_abstraction_fraction_initial</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxSWagent</span><span class="p">,</span>
                                                                                     <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Channel_Irrigation</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">using_lift_areas</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lift_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxSWagent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                                                      <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relax_abstraction_fraction_initial</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxSWagent</span><span class="p">,</span>
                                                                                      <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lift_Irrigation</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lake_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxSWagent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relax_abstraction_fraction_initial</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxSWagent</span><span class="p">,</span>
                                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lake_Irrigation</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Res_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxSWagent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relax_abstraction_fraction_initial</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxSWagent</span><span class="p">,</span>
                                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Res_Irrigation</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;irrigation_agent_GW_request_month_m3&#39;</span> <span class="ow">in</span> <span class="n">binding</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">activate_irrigation_agents</span><span class="p">:</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span> <span class="ow">and</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;limitAbstraction&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Irrigation</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span>
                            <span class="s1">&#39;gwAbstractionFraction_Irrigation&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Irrigation</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relax_irrigation_agents</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxGWagent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                                             <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relax_abstraction_fraction_initial</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxGWagent</span><span class="p">,</span>
                                                                             <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Irrigation</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;commandAreasRelaxGwAbstraction&#39;</span> <span class="ow">in</span> <span class="n">binding</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                                         <span class="mf">0.01</span><span class="p">,</span>
                                                                         <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Irrigation</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span> <span class="ow">and</span> <span class="s1">&#39;commandAreasRelaxGwAbstraction&#39;</span> <span class="ow">in</span> <span class="n">binding</span> <span class="ow">and</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">using_reservoir_command_areas</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">dateVar</span><span class="p">[</span><span class="s1">&#39;currDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">day</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                                         <span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;commandAreasRelaxGwAbstraction&#39;</span><span class="p">),</span>
                                                                         <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Irrigation</span><span class="p">)</span>
            
            
            <span class="c1"># Desalination</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_DesalWaterAbstractM3</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># Desalination is not allowed without sectorSourceAbstractionFractions</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeDesal</span><span class="p">:</span>
                    <span class="n">pot_Desal_Domestic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">othAbstractionFraction_Desal_Domestic</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span>
                    <span class="n">pot_Desal_Livestock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">othAbstractionFraction_Desal_Livestock</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span>
                    <span class="n">pot_Desal_Industry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">othAbstractionFraction_Desal_Industry</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span>
                    <span class="n">pot_Desal_Irrigation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">othAbstractionFraction_Desal_Irrigation</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span>

                    <span class="n">pot_DesalAbst</span> <span class="o">=</span> <span class="n">pot_Desal_Domestic</span> <span class="o">+</span> <span class="n">pot_Desal_Livestock</span> <span class="o">+</span> <span class="n">pot_Desal_Industry</span> <span class="o">+</span> <span class="n">pot_Desal_Irrigation</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unlimitedDesal</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">AvlDesalM3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">desalAnnualCap</span><span class="p">[</span><span class="n">dateVar</span><span class="p">[</span><span class="s1">&#39;currDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">]</span> <span class="o">/</span> <span class="mi">365</span>
                        <span class="n">abstractLimitCoeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">pot_DesalAbst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">AvlDesalM3</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">pot_DesalAbst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_DesalWaterAbstractM</span> <span class="o">=</span> <span class="n">pot_DesalAbst</span> <span class="o">*</span> <span class="n">abstractLimitCoeff</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_DesalWaterAbstractM</span> <span class="o">=</span> <span class="n">pot_DesalAbst</span>
     
                    <span class="c1">#self.var.act_DesalWaterAbstractM = self.var.act_DesalWaterAbstractM3 / self.var.cellArea</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeDesal</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Domestic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_DesalWaterAbstractM</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">othAbstractionFraction_Desal_Domestic</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Livestock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_DesalWaterAbstractM</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Domestic</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">othAbstractionFraction_Desal_Livestock</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Industry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_DesalWaterAbstractM</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Livestock</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">othAbstractionFraction_Desal_Industry</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_DesalWaterAbstractM</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Industry</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">othAbstractionFraction_Desal_Irrigation</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span><span class="p">)</span>
               
                
            
            <span class="c1"># surface water abstraction that can be extracted to fulfill totalDemand</span>
            <span class="c1"># - based on ChannelStorage and swAbstractionFraction * totalDemand</span>
            <span class="c1"># sum up potential surface water abstraction (no groundwater abstraction under water and sealed area)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>                            
                <span class="n">pot_Channel_Domestic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Channel_Domestic</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span><span class="p">,</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Domestic</span><span class="p">)</span>                
                <span class="n">pot_Channel_Livestock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Channel_Livestock</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span><span class="p">,</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Livestock</span><span class="p">)</span>
                <span class="n">pot_Channel_Industry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Channel_Industry</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span><span class="p">,</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Industry</span><span class="p">)</span>
                <span class="n">pot_Channel_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Channel_Irrigation</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span><span class="p">,</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Irrigation</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;irrigation_agent_SW_request_month_m3&#39;</span> <span class="ow">in</span> <span class="n">binding</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">activate_irrigation_agents</span><span class="p">:</span>
                    <span class="n">pot_Channel_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">pot_Channel_Irrigation</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrWithdrawalSW_max</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">InvCellArea</span><span class="p">)</span>

                <span class="n">pot_channelAbst</span> <span class="o">=</span> <span class="n">pot_Channel_Domestic</span> <span class="o">+</span> <span class="n">pot_Channel_Livestock</span> <span class="o">+</span> <span class="n">pot_Channel_Industry</span> <span class="o">+</span> <span class="n">pot_Channel_Irrigation</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlChannelStorageM</span><span class="p">,</span> <span class="n">pot_channelAbst</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pot_SurfaceAbstract</span> <span class="o">=</span> <span class="n">totalDemand</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction</span>
                <span class="c1"># only local surface water abstraction is allowed (network is only within a cell)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlChannelStorageM</span><span class="p">,</span> <span class="n">pot_SurfaceAbstract</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlChannelStorageM</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_channelAbst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># if surface water is not sufficient it is taken from groundwater</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_channelAbst</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Channel_Domestic</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_channelAbst</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Channel_Livestock</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Industry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_channelAbst</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Channel_Industry</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_channelAbst</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Industry</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Channel_Irrigation</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span><span class="p">)</span>

            <span class="c1"># UNDER CONSTRUCTION</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">using_lift_areas</span><span class="p">:</span>
                <span class="c1"># Lift development When there is sufficient water in the Segment to fulfill demand, the water is</span>
                <span class="c1"># taken away proportionally from each cell&#39;s readAvlChannelStorageM in the Segment. For example,</span>
                <span class="c1"># if total demand can be filled with 50% of total availability, then 50% of the</span>
                <span class="c1"># readAvlChannelStorageM from each cell is used. Note that if a cell has too little Channel Storage,</span>
                <span class="c1"># then no water will be taken from the cell as this was dealt with earlier:  readAvlChannelStorage =</span>
                <span class="c1"># 0 if &lt; (0.0005 * self.var.cellArea) Note: Due to the shared use of abstracted channel storage,</span>
                <span class="c1"># a cell may abstract more than its pot_SurfaceAbstract, as well as not necessarily satisfy its</span>
                <span class="c1"># pot_SurfaceAbstract</span>
                
                <span class="n">pot_Lift_Domestic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lift_Domestic</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span><span class="p">,</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic</span> <span class="p">)</span>                
                <span class="n">pot_Lift_Livestock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lift_Livestock</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span><span class="p">,</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock</span><span class="p">)</span>
                <span class="n">pot_Lift_Industry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lift_Industry</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span><span class="p">,</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Industry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Industry</span> <span class="p">)</span>
                <span class="n">pot_Lift_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lift_Irrigation</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span><span class="p">,</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Irrigation</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Irrigation</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;irrigation_agent_SW_request_month_m3&#39;</span> <span class="ow">in</span> <span class="n">binding</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">activate_irrigation_agents</span><span class="p">:</span>
                    <span class="n">pot_Lift_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">pot_Lift_Irrigation</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrWithdrawalSW_max</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">InvCellArea</span><span class="p">)</span>

                <span class="n">pot_liftAbst</span> <span class="o">=</span> <span class="n">pot_Lift_Domestic</span> <span class="o">+</span> <span class="n">pot_Lift_Livestock</span> <span class="o">+</span> <span class="n">pot_Lift_Industry</span> <span class="o">+</span> <span class="n">pot_Lift_Irrigation</span>


                <span class="n">remainNeed_afterLocal</span> <span class="o">=</span> <span class="n">pot_liftAbst</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="c1"># The remaining demand within each command area [M3] is put into a map where each cell in the command</span>
                <span class="c1"># area holds this total demand</span>
                <span class="n">demand_Segment_lift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lift_command_areas</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                               <span class="n">npareatotal</span><span class="p">(</span><span class="n">remainNeed_afterLocal</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">,</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lift_command_areas</span><span class="p">),</span>
                                               <span class="mi">0</span><span class="p">)</span>  <span class="c1"># [M3]</span>

                <span class="n">available_Segment_lift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lift_command_areas</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                  <span class="n">npareatotal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlChannelStorageM</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lift_command_areas</span><span class="p">),</span>
                                                  <span class="mi">0</span><span class="p">)</span>  <span class="c1"># [M3]</span>

                <span class="n">frac_used_Segment_lift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">available_Segment_lift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">demand_Segment_lift</span> <span class="o">/</span> <span class="n">available_Segment_lift</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_channelAbst</span> <span class="o">+=</span> <span class="p">(</span><span class="n">frac_used_Segment_lift</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlChannelStorageM</span><span class="p">)</span>

                <span class="n">metRemainSegment_lift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">demand_Segment_lift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                 <span class="n">divideValues</span><span class="p">(</span><span class="n">frac_used_Segment_lift</span> <span class="o">*</span> <span class="n">available_Segment_lift</span><span class="p">,</span>
                                                              <span class="n">demand_Segment_lift</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">metRemainSegment_lift</span> <span class="o">=</span> <span class="n">metRemainSegment_lift</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">lift_abstractions</span> <span class="o">=</span> <span class="n">metRemainSegment_lift</span> <span class="o">*</span> <span class="n">remainNeed_afterLocal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span> <span class="o">+=</span> <span class="n">lift_abstractions</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlChannelStorageM</span> <span class="o">-=</span> <span class="p">(</span><span class="n">frac_used_Segment_lift</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlChannelStorageM</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlChannelStorageM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlChannelStorageM</span> <span class="o">&lt;</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlChannelStorageM</span><span class="p">)</span>
                <span class="c1"># Used in landCover for riverbedExchange</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_channelAbstract_Lift</span> <span class="o">=</span> <span class="n">frac_used_Segment_lift</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlChannelStorageM</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>

                    <span class="c1"># A</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Domestic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">lift_abstractions</span><span class="p">,</span> <span class="n">pot_Lift_Domestic</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Livestock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">lift_abstractions</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Domestic</span><span class="p">,</span>
                                                         <span class="n">pot_Lift_Livestock</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Industry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="n">lift_abstractions</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Livestock</span><span class="p">,</span>
                        <span class="n">pot_Lift_Industry</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="n">lift_abstractions</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Industry</span><span class="p">,</span>
                        <span class="n">pot_Lift_Irrigation</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;includeWaterBodies&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">abstractedLakeReservoirM3C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeWastewater</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">load_command_areas_wwt</span><span class="p">:</span>
                        <span class="n">wwtDemandAreaMask</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyBuffer_wwt</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">wwtDemandAreaMask</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        
                        
                        
                <span class="c1"># First apply to wastewater reclamation, e.g., restricted use reservoirs. Follow by lakes and reservoirs (not restricted)                </span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeWastewater</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                        <span class="n">pot_wwt_Domestic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtAbstractionFraction_Res_Domestic</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Domestic</span><span class="p">)</span> <span class="o">*</span> <span class="n">wwtDemandAreaMask</span>
                
                        <span class="n">pot_wwt_Livestock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtAbstractionFraction_Res_Livestock</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Livestock</span><span class="p">)</span> <span class="o">*</span> <span class="n">wwtDemandAreaMask</span>

                        <span class="n">pot_wwt_Industry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtAbstractionFraction_Res_Industry</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Industry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Industry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Industry</span><span class="p">)</span> <span class="o">*</span> <span class="n">wwtDemandAreaMask</span>
                        
                        <span class="n">pot_wwt_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtAbstractionFraction_Res_Irrigation</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Irrigation</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Irrigation</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Irrigation</span><span class="p">)</span> <span class="o">*</span> <span class="n">wwtDemandAreaMask</span>
                        
                        <span class="n">remainNeed</span> <span class="o">=</span> <span class="n">pot_wwt_Domestic</span> <span class="o">+</span> <span class="n">pot_wwt_Livestock</span> <span class="o">+</span> <span class="n">pot_wwt_Industry</span> <span class="o">+</span> <span class="n">pot_wwt_Irrigation</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">remainNeed</span> <span class="o">=</span> <span class="n">remainNeed</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        
                        <span class="c1"># UPDATE ALL SECTORSOURCEABSTRACTIONFRACTIONS BELOW</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">irrFracDemand</span> <span class="o">=</span> <span class="n">divideValues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrDemand</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span><span class="p">)</span>

                        <span class="c1"># water that is still needed from surface water  - in this case only consider irrigation</span>
                        <span class="n">remainNeed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">pot_SurfaceAbstract</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">wwtDemandAreaMask</span> <span class="o">*</span> <span class="n">irrFracDemand</span>
                    <span class="c1"># start wastewater allocation</span>
                   
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">load_command_areas_wwt</span><span class="p">:</span>
                        <span class="c1">## opt 1: buffer with no command areas is used</span>
                        <span class="c1"># remainNeedBig = npareatotal(remainNeed, self.var.waterBodyID)</span>
                        <span class="n">remainNeedBig_wwt</span> <span class="o">=</span> <span class="n">npareatotal</span><span class="p">(</span><span class="n">remainNeed</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyBuffer_wwt</span><span class="p">)</span>
                        <span class="n">remainNeedBig_wwtC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="n">remainNeedBig_wwt</span><span class="p">)</span>
                        <span class="c1">#print(np.compress(self.var.compress_LR, npareatotal(remainNeed * self.var.cellArea,  self.var.waterBodyBuffer_wwt)))</span>
                        <span class="c1"># Storage of a big lake</span>
                        <span class="n">ReservoirsThatAreCurrentlyReservoirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyTypCTemp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyTypCTemp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        
                        <span class="n">ReservoirsThatAreCurrentlyReservoirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">resId_restricted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ReservoirsThatAreCurrentlyReservoirs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        
                        
                        <span class="n">lakeResStorageC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyTypCTemp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyTypCTemp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeStorageC</span><span class="p">,</span>
                                                        <span class="n">ReservoirsThatAreCurrentlyReservoirs</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">MtoM3C</span>

                        <span class="n">minlake</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.98</span> <span class="o">*</span> <span class="n">lakeResStorageC</span><span class="p">)</span>  <span class="c1"># reasonable but arbitrary limit</span>
                        <span class="n">act_bigLakeAbst_wwtC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">minlake</span><span class="p">,</span> <span class="n">remainNeedBig_wwtC</span><span class="p">)</span>
                     
                        <span class="c1"># substract from both, because it is sorted by self.var.waterBodyTypCTemp</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeStorageC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeStorageC</span> <span class="o">-</span> <span class="n">act_bigLakeAbst_wwtC</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">MtoM3C</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeVolumeM3C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeVolumeM3C</span> <span class="o">-</span> <span class="n">act_bigLakeAbst_wwtC</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">MtoM3C</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">-</span> <span class="n">act_bigLakeAbst_wwtC</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">MtoM3C</span>
                        <span class="c1"># and from the combined onenpfor waterbalance issues</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorageC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorageC</span> <span class="o">-</span> <span class="n">act_bigLakeAbst_wwtC</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">MtoM3C</span>
    
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">abstractedLakeReservoirM3C</span> <span class="o">+=</span> <span class="n">act_bigLakeAbst_wwtC</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">MtoM3C</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorage</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorage</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorageC</span><span class="p">)</span>
                        <span class="n">bigLakesFactor_wwtC</span> <span class="o">=</span> <span class="n">divideValues</span><span class="p">(</span><span class="n">act_bigLakeAbst_wwtC</span><span class="p">,</span> <span class="n">remainNeedBig_wwtC</span><span class="p">)</span>
                        <span class="c1"># and back to the big array</span>
                        <span class="n">bigLakesFactor_wwt</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">bigLakesFactor_wwt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span> <span class="n">bigLakesFactor_wwtC</span><span class="p">)</span>

                        <span class="c1"># bigLakesFactorAllaroundlake = npareamaximum(bigLakesFactor, self.var.waterBodyID)</span>
                        <span class="n">bigLakesFactorAllaroundlake_wwt</span> <span class="o">=</span> <span class="n">npareamaximum</span><span class="p">(</span><span class="n">bigLakesFactor_wwt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyBuffer_wwt</span><span class="p">)</span>
                        <span class="c1">#print(np.compress(self.var.compress_LR, bigLakesFactorAllaroundlake_wwt))</span>
                        <span class="c1"># abstraction from big lakes is partioned to the users around the lake</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst_wwt</span> <span class="o">=</span> <span class="n">remainNeed</span> <span class="o">*</span> <span class="n">bigLakesFactorAllaroundlake_wwt</span>
                        <span class="c1"># remaining need is used from lakes and reservoirs without water use restrictions</span>
                        <span class="c1">#remainNeed0 = remainNeed * (1 - bigLakesFactorAllaroundlake_wwt)</span>
                       
                        
                        <span class="c1"># allocate water demand in case sectorSourceAbstractionFractions = True</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Domestic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst_wwt</span><span class="p">,</span>
                                                           <span class="n">pot_wwt_Domestic</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Livestock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst_wwt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Domestic</span><span class="p">,</span>
                                                                <span class="n">pot_wwt_Livestock</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Industry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst_wwt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Livestock</span><span class="p">,</span>
                                <span class="n">pot_wwt_Industry</span><span class="p">)</span>
                            
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst_wwt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Industry</span><span class="p">,</span>
                                <span class="n">pot_wwt_Irrigation</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1">## opt 2:  command areas are used</span>
                        <span class="c1">#self.var.abstractedLakeReservoirM3C = np.compress(self.var.compress_LR, globals.inZero.copy())</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_ResAbst_wwt</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst_wwt</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                        <span class="k">if</span> <span class="s1">&#39;Reservoir_releases&#39;</span> <span class="ow">in</span> <span class="n">binding</span><span class="p">:</span>
                        <span class="c1"># resStorage_maxFracForIrrigation = 0.5 + globals.inZero.copy()</span>
                            <span class="n">resStorage_maxFracForIrrigation</span> <span class="o">=</span> <span class="n">readnetcdf2</span><span class="p">(</span><span class="s1">&#39;Reservoir_releases&#39;</span><span class="p">,</span> <span class="n">day_of_year</span><span class="p">,</span>
                                                                        <span class="n">useDaily</span><span class="o">=</span><span class="s1">&#39;DOY&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Fraction of Volume&#39;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="s1">&#39;wwt_reservoir_releases&#39;</span> <span class="ow">in</span> <span class="n">binding</span><span class="p">:</span>
                            <span class="n">resStorage_maxFracForIrrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;wwt_reservoir_releases&#39;</span><span class="p">),</span> <span class="mf">1.</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">resStorage_maxFracForIrrigation</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                                
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                            <span class="n">remainNeedPre</span> <span class="o">=</span> <span class="n">pot_wwt_Domestic</span> <span class="o">+</span> <span class="n">pot_wwt_Livestock</span> <span class="o">+</span> <span class="n">pot_wwt_Industry</span>
                            <span class="n">remainNeed</span> <span class="o">=</span> <span class="n">pot_wwt_Irrigation</span>
                            
                            <span class="n">demand_Segment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                    <span class="n">npareatotal</span><span class="p">(</span><span class="n">remainNeedPre</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">,</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span><span class="p">),</span>
                                                        <span class="mi">0</span><span class="p">)</span>  <span class="c1"># [M3]</span>
                            <span class="c1"># Reservoir associated with the Command Area</span>
                            <span class="c1">#</span>
                            <span class="c1"># If there is more than one reservoir in a command area, the storage of the reservoir with</span>
                            <span class="c1"># maximum storage in this time-step is chosen. The map resStorageTotal_alloc holds this</span>
                            <span class="c1"># maximum reservoir storage within a command area in all cells within that command area</span>
                            
                            <span class="c1"># Non Irrigation</span>
                            
                            <span class="n">ReservoirsThatAreCurrentlyReservoirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyTypCTemp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyTypCTemp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                            <span class="n">ReservoirsThatAreCurrentlyReservoirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">resId_restricted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ReservoirsThatAreCurrentlyReservoirs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">reservoirStorageM3</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="c1"># np.put(reservoirStorageM3, self.var.decompress_LR, self.var.reservoirStorageM3C)</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">reservoirStorageM3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span> <span class="n">ReservoirsThatAreCurrentlyReservoirs</span><span class="p">)</span>
                            <span class="n">resStorageTotal_alloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                            <span class="n">npareamaximum</span><span class="p">(</span><span class="n">reservoirStorageM3</span><span class="p">,</span>
                                                                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># [M3]</span>

                            <span class="c1"># In the map resStorageTotal_allocC, the maximum storage from each allocation segment is held</span>
                            <span class="c1"># in all reservoir cells within that allocation segment. We now correct to remove the</span>
                            <span class="c1"># reservoirs that are not this maximum-storage-reservoir for the command area.</span>
                            <span class="n">resStorageTotal_allocC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="n">resStorageTotal_alloc</span><span class="p">)</span>
                            <span class="n">resStorageTotal_allocC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">resStorageTotal_allocC</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span>
                                                                <span class="n">resStorageTotal_allocC</span><span class="p">)</span>
                            
                            <span class="n">day_of_year</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">dateVar</span><span class="p">[</span><span class="s1">&#39;currDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span>
                         
                            <span class="c1"># resStorage_maxFracForIrrigationC holds the fractional rules found for each reservoir,</span>
                            <span class="c1"># so we must null those that are not the maximum-storage reservoirs</span>
                            <span class="n">resStorage_maxFracForIrrigationC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span>
                                                                       <span class="n">resStorage_maxFracForIrrigation</span><span class="p">)</span>
                            <span class="n">resStorage_maxFracForIrrigationC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                                <span class="n">resStorageTotal_allocC</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span> <span class="n">resStorage_maxFracForIrrigationC</span><span class="p">)</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">resStorage_maxFracForIrrigation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span>
                                <span class="n">resStorage_maxFracForIrrigationC</span><span class="p">)</span>

                            <span class="n">resStorage_maxFracForIrrigation_CA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                                      <span class="n">npareamaximum</span><span class="p">(</span><span class="n">resStorage_maxFracForIrrigation</span><span class="p">,</span>
                                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span><span class="p">),</span>
                                                                      <span class="mi">0</span><span class="p">)</span>
                                                                      
                            <span class="n">act_bigLakeResAbst_alloc_wwt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                <span class="n">resStorage_maxFracForIrrigation_CA</span> <span class="o">*</span> <span class="n">resStorageTotal_alloc</span><span class="p">,</span>
                                <span class="n">demand_Segment</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Water_conveyance_efficiency</span><span class="p">)</span>  <span class="c1"># [M3]</span>
                            
                            <span class="c1"># fraction of water abstracted versus water available for total segment reservoir volumes</span>
                            <span class="n">ResAbstractFactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">resStorageTotal_alloc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                        <span class="n">divideValues</span><span class="p">(</span><span class="n">act_bigLakeResAbst_alloc_wwt</span><span class="p">,</span> <span class="n">resStorageTotal_alloc</span><span class="p">),</span>
                                                        <span class="mi">0</span><span class="p">)</span>
                            
                            <span class="c1"># Compressed version needs to be corrected as above</span>
                            <span class="n">ResAbstractFactorC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="n">ResAbstractFactor</span><span class="p">)</span>
                            <span class="n">ResAbstractFactorC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">resStorageTotal_allocC</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span>
                                                            <span class="n">ResAbstractFactorC</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeStorageC</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeVolumeM3C</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorageC</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">abstractedLakeReservoirM3C</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>

                            <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">abstractedLakeReservoirM3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">abstractedLakeReservoirM3C</span><span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorage</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorage</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorageC</span><span class="p">)</span>

                            <span class="n">metRemainSegment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">demand_Segment</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                        <span class="n">divideValues</span><span class="p">(</span><span class="n">act_bigLakeResAbst_alloc_wwt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Water_conveyance_efficiency</span><span class="p">,</span>
                                                                    <span class="n">demand_Segment</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># by definition &lt;= 1</span>
                            
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst_wwt</span> <span class="o">=</span> <span class="n">remainNeedPre</span> <span class="o">*</span> <span class="n">metRemainSegment</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span> <span class="o">+=</span> <span class="n">remainNeedPre</span> <span class="o">*</span> <span class="n">metRemainSegment</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_ResAbst_wwt</span> <span class="o">=</span> <span class="n">remainNeedPre</span> <span class="o">*</span> <span class="n">metRemainSegment</span>
                        
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Domestic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_ResAbst_wwt</span><span class="p">,</span>
                                                           <span class="n">pot_wwt_Domestic</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Livestock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_ResAbst_wwt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Domestic</span><span class="p">,</span>
                                                                <span class="n">pot_wwt_Livestock</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Industry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_ResAbst_wwt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Livestock</span><span class="p">,</span>
                                <span class="n">pot_wwt_Industry</span><span class="p">)</span>
                         
                        <span class="c1"># Irrigation</span>

                        <span class="n">demand_Segment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                            <span class="n">npareatotal</span><span class="p">(</span><span class="n">remainNeed</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span><span class="p">),</span>
                                            <span class="mi">0</span><span class="p">)</span>  <span class="c1"># [M3]</span>


                        <span class="n">ReservoirsThatAreCurrentlyReservoirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyTypCTemp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span>
                                                                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyTypCTemp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        
                        <span class="n">ReservoirsThatAreCurrentlyReservoirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">resId_restricted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ReservoirsThatAreCurrentlyReservoirs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">reservoirStorageM3</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="c1"># np.put(reservoirStorageM3, self.var.decompress_LR, self.var.reservoirStorageM3C)</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">reservoirStorageM3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span> <span class="n">ReservoirsThatAreCurrentlyReservoirs</span><span class="p">)</span>

                        <span class="n">resStorageTotal_alloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                    <span class="n">npareamaximum</span><span class="p">(</span><span class="n">reservoirStorageM3</span><span class="p">,</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># [M3]</span>

                        <span class="c1"># In the map resStorageTotal_allocC, the maximum storage from each allocation segment</span>
                        <span class="c1">#   is held in all reservoir cells within that allocation segment.</span>
                        <span class="c1"># We now correct to remove the reservoirs</span>
                        <span class="c1">#   that are not this maximum-storage-reservoir for the command area.</span>
                        <span class="n">resStorageTotal_allocC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="n">resStorageTotal_alloc</span><span class="p">)</span>
                        <span class="n">resStorageTotal_allocC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">resStorageTotal_allocC</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span>
                                                            <span class="n">resStorageTotal_allocC</span><span class="p">)</span>

                        <span class="c1"># resStorage_maxFracForIrrigationC holds the fractional rules found for each reservoir,</span>
                        <span class="c1">#   so we must null those that are not the maximum-storage reservoirs</span>
                        <span class="n">resStorage_maxFracForIrrigationC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span>
                                                                    <span class="n">resStorage_maxFracForIrrigation</span><span class="p">)</span>
                        <span class="n">resStorage_maxFracForIrrigationC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                        <span class="n">resStorageTotal_allocC</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span> <span class="n">resStorage_maxFracForIrrigationC</span><span class="p">)</span>                        
                        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">resStorage_maxFracForIrrigation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span>
                               <span class="n">resStorage_maxFracForIrrigationC</span><span class="p">)</span>
                        

                        <span class="n">resStorage_maxFracForIrrigation_CA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                                    <span class="n">npareamaximum</span><span class="p">(</span><span class="n">resStorage_maxFracForIrrigation</span><span class="p">,</span>
                                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas_wwt</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>


                        <span class="n">act_bigLakeResAbst_alloc_wwt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">resStorage_maxFracForIrrigation_CA</span> <span class="o">*</span> <span class="n">resStorageTotal_alloc</span><span class="p">,</span>
                                                            <span class="n">demand_Segment</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Water_conveyance_efficiency</span><span class="p">)</span>  <span class="c1"># [M3]</span>

                        <span class="n">ResAbstractFactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">resStorageTotal_alloc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                    <span class="n">divideValues</span><span class="p">(</span><span class="n">act_bigLakeResAbst_alloc_wwt</span><span class="p">,</span> <span class="n">resStorageTotal_alloc</span><span class="p">),</span>
                                                    <span class="mi">0</span><span class="p">)</span>
                                                    
                        <span class="c1"># fraction of water abstracted versus water available for total segment reservoir volumes</span>
                        <span class="c1"># Compressed version needs to be corrected as above</span>
                        <span class="n">ResAbstractFactorC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="n">ResAbstractFactor</span><span class="p">)</span>
                        <span class="n">ResAbstractFactorC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">resStorageTotal_allocC</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span>
                                                        <span class="n">ResAbstractFactorC</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeStorageC</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeVolumeM3C</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorageC</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">abstractedLakeReservoirM3C</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>

                        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">abstractedLakeReservoirM3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">abstractedLakeReservoirM3C</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorage</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorage</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorageC</span><span class="p">)</span>

                        <span class="n">metRemainSegment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">demand_Segment</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                    <span class="n">divideValues</span><span class="p">(</span><span class="n">act_bigLakeResAbst_alloc_wwt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Water_conveyance_efficiency</span><span class="p">,</span>
                                                                <span class="n">demand_Segment</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># by definition &lt;= 1</span>
                            
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst_wwt</span> <span class="o">+=</span> <span class="n">remainNeed</span> <span class="o">*</span> <span class="n">metRemainSegment</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_ResAbst_wwt</span> <span class="o">+=</span> <span class="n">remainNeed</span> <span class="o">*</span> <span class="n">metRemainSegment</span>
                            
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakage_wwtC_daily</span> <span class="o">=</span> <span class="n">resStorageTotal_allocC</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span> <span class="o">*</span> <span class="p">(</span>
                                <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Water_conveyance_efficiency</span><span class="p">))</span>

                        
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                <span class="n">remainNeed</span> <span class="o">*</span> <span class="n">metRemainSegment</span><span class="p">,</span>
                                <span class="n">pot_wwt_Irrigation</span><span class="p">)</span>
                        
                        <span class="c1">## End of using_reservoir_command_areas_wwt</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst_wwt</span>
                <span class="c1"># Lakes and reservoirs are both considered lakes for purposes of lake abstraction,</span>
                <span class="c1"># both satisfying demands within waterbody cells or within self.var.waterBodyBuffer</span>
                <span class="c1"># depending on abstraction fractions</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>

                    <span class="n">pot_Lake_Domestic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lake_Domestic</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Domestic</span> <span class="o">-</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Domestic</span><span class="p">)</span>

                    <span class="n">pot_Lake_Livestock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lake_Livestock</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock</span> <span class="o">-</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Livestock</span><span class="p">)</span>

                    <span class="n">pot_Lake_Industry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lake_Industry</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Industry</span> <span class="o">-</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Industry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Industry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Industry</span><span class="p">)</span>

                    <span class="n">pot_Lake_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lake_Irrigation</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Irrigation</span> <span class="o">-</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Irrigation</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Irrigation</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Irrigation</span><span class="p">)</span>

                    <span class="n">remainNeed0</span> <span class="o">=</span> <span class="n">pot_Lake_Domestic</span> <span class="o">+</span> <span class="n">pot_Lake_Livestock</span> <span class="o">+</span> <span class="n">pot_Lake_Industry</span> <span class="o">+</span> <span class="n">pot_Lake_Irrigation</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="c1"># water that is still needed from surface water</span>
                    <span class="n">remainNeed0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">pot_SurfaceAbstract</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeWastewater</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">abstractedLakeReservoirM3C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>  
                <span class="n">mskWtrBody_unrestricted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyBuffer</span> <span class="o">&gt;</span> <span class="mi">0</span>
                
                <span class="c1"># first from big Lakes and reservoirs, big lakes cover several gridcells</span>
                <span class="c1"># collect all water demand from lake pixels of the same id</span>

                <span class="c1"># remainNeedBig = npareatotal(remainNeed, self.var.waterBodyID)</span>
                <span class="c1"># not only the lakes and reservoirs but the command areas around water bodies e.g. here a buffer</span>
                <span class="n">remainNeedBig</span> <span class="o">=</span> <span class="n">npareatotal</span><span class="p">(</span><span class="n">remainNeed0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyBuffer</span><span class="p">)</span>
                <span class="n">remainNeedBigC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="n">remainNeedBig</span><span class="p">)</span>

                <span class="c1"># Storage of a big lake</span>
                <span class="n">lakeResStorageC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyTypCTemp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span>
                                           <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyTypCTemp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeStorageC</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">MtoM3C</span>

                <span class="n">minlake</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.98</span> <span class="o">*</span> <span class="n">lakeResStorageC</span><span class="p">)</span>  <span class="c1"># reasonable but arbitrary limit</span>
                <span class="n">act_bigLakeAbstC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">minlake</span><span class="p">,</span> <span class="n">remainNeedBigC</span><span class="p">)</span>
                <span class="c1"># substract from both, because it is sorted by self.var.waterBodyTypCTemp</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeStorageC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeStorageC</span> <span class="o">-</span> <span class="n">act_bigLakeAbstC</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">MtoM3C</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeVolumeM3C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeVolumeM3C</span> <span class="o">-</span> <span class="n">act_bigLakeAbstC</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">MtoM3C</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">-</span> <span class="n">act_bigLakeAbstC</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">MtoM3C</span>
                <span class="c1"># and from the combined one for waterbalance issues</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorageC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorageC</span> <span class="o">-</span> <span class="n">act_bigLakeAbstC</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">MtoM3C</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">abstractedLakeReservoirM3C</span> <span class="o">=</span> <span class="n">act_bigLakeAbstC</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">MtoM3C</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorage</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorage</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorageC</span><span class="p">)</span>
                <span class="n">bigLakesFactorC</span> <span class="o">=</span> <span class="n">divideValues</span><span class="p">(</span><span class="n">act_bigLakeAbstC</span><span class="p">,</span> <span class="n">remainNeedBigC</span><span class="p">)</span>

                <span class="c1"># and back to the big array</span>
                <span class="n">bigLakesFactor</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">bigLakesFactor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span> <span class="n">bigLakesFactorC</span><span class="p">)</span>

                <span class="c1"># bigLakesFactorAllaroundlake = npareamaximum(bigLakesFactor, self.var.waterBodyID)</span>
                <span class="n">bigLakesFactorAllaroundlake</span> <span class="o">=</span> <span class="n">npareamaximum</span><span class="p">(</span><span class="n">bigLakesFactor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyBuffer</span><span class="p">)</span>

                <span class="c1"># abstraction from big lakes is partioned to the users around the lake</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst</span> <span class="o">=</span> <span class="n">remainNeed0</span>  <span class="o">*</span> <span class="n">mskWtrBody_unrestricted</span> <span class="o">*</span> <span class="n">bigLakesFactorAllaroundlake</span>   

                <span class="c1"># remaining need is used from small lakes</span>
                <span class="n">remainNeed1</span> <span class="o">=</span> <span class="n">remainNeed0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">bigLakesFactorAllaroundlake</span><span class="p">)</span>
                <span class="c1"># minlake = np.maximum(0.,self.var.smalllakeStorage - self.var.minsmalllakeStorage) * self.var.M3toM</span>

                <span class="k">if</span> <span class="n">returnBool</span><span class="p">(</span><span class="s1">&#39;useSmallLakes&#39;</span><span class="p">):</span>
                    <span class="n">minlake</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.98</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">smalllakeStorage</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">M3toM</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_smallLakeResAbst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">minlake</span><span class="p">,</span> <span class="n">remainNeed1</span><span class="p">)</span>
                    <span class="c1"># act_smallLakesres is substracted from small lakes storage</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">smalllakeVolumeM3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">smalllakeVolumeM3</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_smallLakeResAbst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">MtoM3</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">smalllakeStorage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">smalllakeStorage</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_smallLakeResAbst</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">MtoM3</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_smallLakeResAbst</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># available surface water is from river network + large/small lake &amp; reservoirs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst</span> \
                                                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_smallLakeResAbst</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_lakeAbst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_smallLakeResAbst</span>

                <span class="c1"># Transfer water between reservoirs</span>
                <span class="c1"># Send storage between reservoirs using the Excel sheet reservoir_transfers within cwatm_settings.xlsx</span>
                <span class="c1"># Using the waterBodyIDs defined in the settings, designate</span>
                <span class="c1"># the Giver, the Receiver, and the daily fraction of live storage the Giver sends to the Receiver.</span>
                <span class="c1"># If the Receiver is already at capacity, the Giver does not send any storage.</span>
                <span class="c1"># Reservoirs can only send to one reservoir. Reservoirs can receive from several reservoirs.</span>

                <span class="k">if</span> <span class="s1">&#39;reservoir_transfers&#39;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;reservoir_transfers&#39;</span><span class="p">):</span>

                        <span class="k">for</span> <span class="n">transfer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers</span><span class="p">:</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">inZero_C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

                            <span class="k">if</span> <span class="n">returnBool</span><span class="p">(</span><span class="s1">&#39;dynamicLakesRes&#39;</span><span class="p">):</span>
                                <span class="n">year</span> <span class="o">=</span> <span class="n">dateVar</span><span class="p">[</span><span class="s1">&#39;currDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">year</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">year</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;fixLakesResYear&#39;</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">transfer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">index_giver</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyID_C</span> <span class="o">==</span> <span class="n">transfer</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">giver_already_constructed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">resYearC</span><span class="p">[</span><span class="n">index_giver</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">year</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">giver_already_constructed</span> <span class="o">=</span> <span class="kc">True</span>

                            <span class="k">if</span> <span class="n">transfer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">index_receiver</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyID_C</span> <span class="o">==</span> <span class="n">transfer</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">receiver_already_constructed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">resYearC</span><span class="p">[</span><span class="n">index_receiver</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">year</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">receiver_already_constructed</span> <span class="o">=</span> <span class="kc">True</span>

                            <span class="k">if</span> <span class="n">receiver_already_constructed</span> <span class="ow">and</span> <span class="n">giver_already_constructed</span><span class="p">:</span>

                                <span class="n">reservoir_unused</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">resVolumeC</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span>
                                <span class="k">if</span> <span class="n">transfer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">reservoir_unused_receiver</span> <span class="o">=</span> <span class="n">reservoir_unused</span><span class="p">[</span><span class="n">index_receiver</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">reservoir_unused_receiver</span> <span class="o">=</span> <span class="mf">10e12</span>

                                <span class="k">if</span> <span class="n">transfer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="c1"># In this case, the fraction refers to the fraction of the receiver,</span>
                                    <span class="c1"># as the giver is infinite</span>
                                    <span class="n">reservoir_storage_giver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">resVolumeC</span><span class="p">[</span><span class="n">index_receiver</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">reservoir_storage_giver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">[</span><span class="n">index_giver</span><span class="p">]</span>

                                <span class="n">reservoir_transfer_actual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">reservoir_unused_receiver</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">,</span>
                                                                       <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">transfer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span>
                                                                                <span class="n">reservoir_storage_giver</span> <span class="o">*</span> <span class="n">transfer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                                                                <span class="n">transfer</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

                                <span class="c1"># print(transfer[0], &#39;donated&#39;, reservoir_transfer_actual, &#39;m3 to&#39;, transfer[1])</span>

                                <span class="k">if</span> <span class="n">transfer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># There is a giver, not the ocean</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">inZero_C</span><span class="p">[</span><span class="n">index_giver</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">reservoir_transfer_actual</span>  <span class="c1"># giver</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_out_M3C</span><span class="p">[</span><span class="n">index_giver</span><span class="p">]</span> <span class="o">+=</span> <span class="n">reservoir_transfer_actual</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_from_outside_M3C</span><span class="p">[</span><span class="n">index_receiver</span><span class="p">]</span> \
                                        <span class="o">+=</span> <span class="n">reservoir_transfer_actual</span>

                                <span class="k">if</span> <span class="n">transfer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># There is a receiver, not the ocean</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">inZero_C</span><span class="p">[</span><span class="n">index_receiver</span><span class="p">]</span> <span class="o">=</span> <span class="n">reservoir_transfer_actual</span>  <span class="c1"># receiver</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_in_M3C</span><span class="p">[</span><span class="n">index_receiver</span><span class="p">]</span> <span class="o">+=</span> <span class="n">reservoir_transfer_actual</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_to_outside_M3C</span><span class="p">[</span><span class="n">index_giver</span><span class="p">]</span> \
                                        <span class="o">+=</span> <span class="n">reservoir_transfer_actual</span>



                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeStorageC</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">inZero_C</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeVolumeM3C</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">inZero_C</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorageC</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">inZero_C</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">inZero_C</span>

                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_net_M3C</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">inZero_C</span>
                                <span class="c1"># Cancels out positive and negative if both receiving and giving</span>

                                <span class="k">if</span> <span class="n">transfer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">to_outside_basin</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">to_outside_basin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">inZero_C</span><span class="p">)</span>
                                    <span class="n">pot_Lake_Industry</span> <span class="o">-=</span> <span class="n">to_outside_basin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">M3toM</span>
                                    <span class="c1"># self.var.Lake_Industry is updated below</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_lakeAbst</span> <span class="o">-=</span> <span class="n">to_outside_basin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">M3toM</span>

                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span> <span class="o">-=</span> <span class="n">to_outside_basin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">M3toM</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst</span> <span class="o">-=</span> <span class="n">to_outside_basin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">M3toM</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst_wwt</span> <span class="o">-=</span> <span class="n">to_outside_basin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">M3toM</span>
                                    
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span> <span class="o">-=</span> <span class="n">to_outside_basin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">M3toM</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_industryConsumption</span> <span class="o">-=</span> <span class="n">to_outside_basin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">M3toM</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ind_efficiency</span> <span class="o">=</span> <span class="n">divideValues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_industryConsumption</span><span class="p">,</span>
                                                                           <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span><span class="p">)</span>


                        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_net_M3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_net_M3C</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_net_M3C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span>
                                                                           <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

                        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_in_M3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_in_M3C</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_in_M3C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span>
                                                                          <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

                        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_out_M3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_out_M3C</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_out_M3C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span>
                                                                           <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

                        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_from_outside_M3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_from_outside_M3C</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_from_outside_M3C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span>
                                                                                    <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

                        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_to_outside_M3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_to_outside_M3C</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_to_outside_M3C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span>
                                                                                  <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

                        <span class="c1">###</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Res_Industry</span> <span class="o">=</span> \
                                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_to_outside_M3</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Res_Industry</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Industry</span> <span class="o">=</span> \
                                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_to_outside_M3</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Industry</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">pot_SurfaceAbstract</span> <span class="o">-=</span> <span class="n">to_outside_basin</span>
                            <span class="c1"># to avoid groundwater abstraction</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction</span> <span class="o">=</span> \
                                <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_transfers_to_outside_M3</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_nonIrr</span><span class="p">)</span>

                <span class="c1"># -------------------------------------</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>

                    <span class="c1"># A</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Domestic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_lakeAbst</span><span class="p">,</span> <span class="n">pot_Lake_Domestic</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Livestock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_lakeAbst</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Domestic</span><span class="p">,</span>
                                                         <span class="n">pot_Lake_Livestock</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Industry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_lakeAbst</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Livestock</span><span class="p">,</span>
                        <span class="n">pot_Lake_Industry</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_lakeAbst</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Industry</span><span class="p">,</span>
                        <span class="n">pot_Lake_Irrigation</span><span class="p">)</span>

                    <span class="c1"># B</span>
                    <span class="n">pot_Res_Domestic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Res_Domestic</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic</span> <span class="o">-</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Domestic</span><span class="p">)</span>

                    <span class="n">pot_Res_Livestock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Res_Livestock</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock</span> <span class="o">-</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Livestock</span><span class="p">)</span>

                    <span class="n">pot_Res_Industry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Res_Industry</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Industry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Industry</span> <span class="o">-</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Industry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Industry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Industry</span><span class="p">)</span>

                    <span class="n">pot_Res_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Res_Irrigation</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Irrigation</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Irrigation</span> <span class="o">-</span> \
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Irrigation</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Irrigation</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Irrigation</span><span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;irrigation_agent_SW_request_month_m3&#39;</span> <span class="ow">in</span> <span class="n">binding</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">activate_irrigation_agents</span><span class="p">:</span>
                        <span class="n">pot_Res_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">pot_Res_Irrigation</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrWithdrawalSW_max</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">InvCellArea</span><span class="p">)</span>

                    <span class="c1"># remainNeed2 = pot_Res_Domestic + pot_Res_Livestock + pot_Res_Industry + pot_Res_Irrigation</span>
                    <span class="n">remainNeed2</span> <span class="o">=</span> <span class="n">pot_Res_Irrigation</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="n">remainNeed2</span> <span class="o">=</span> <span class="n">pot_SurfaceAbstract</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">load_command_areas</span><span class="p">:</span>

                    <span class="c1"># The command area of a reservoir is the area that can receive water from this reservoir. Before</span>
                    <span class="c1"># this step, each cell has attempted to satisfy its demands with local water using in-cell</span>
                    <span class="c1"># channel, lift area, and lake. The remaining demand within each command area is totaled and</span>
                    <span class="c1"># requested from the associated reservoir. The reservoir offers this water up to a daily maximum</span>
                    <span class="c1"># relating to the available storage in the reservoir, defined in the Reservoir_releases_input_file.</span>
                    <span class="c1">#</span>
                    <span class="c1"># SETTINGS FILE AND INPUTS</span>

                    <span class="c1"># -Activating</span>
                    <span class="c1"># In the OPTIONS section towards the beginning of the settings file, add/set</span>
                    <span class="c1"># using_reservoir_command_areas = True</span>

                    <span class="c1"># - Command areas raster map Anywhere after the OPTIONS section (in WATERDEMAND, for example),</span>
                    <span class="c1"># add/set reservoir_command_areas to a path holding... information about the command areas. This</span>
                    <span class="c1"># Command areas raster map should assign the same positive integer coding to each cell within the</span>
                    <span class="c1"># same segment. All other cells must Nan values, or values &lt;= 0.</span>

                    <span class="c1"># -Optional inputs</span>
                    <span class="c1">#</span>
                    <span class="c1"># Anywhere after the OPTIONS section, add/set Reservoir_releases_input_file to a path holding</span>
                    <span class="c1"># information about irrigation releases. This should be a raster map (netCDF) of 366 values</span>
                    <span class="c1"># determining the maximum fraction of available storage to be used for meeting water demand... in</span>
                    <span class="c1"># the associated command area on the day of the year. If this is not included, a value of 0.01</span>
                    <span class="c1"># will be assumed, i.e. 1% of the reservoir storage can be at most released into the command area</span>
                    <span class="c1"># on each day.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_ResAbst</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>

                        <span class="c1"># Domestic, livestock, and industrial demands are satisfied before irrigation</span>

                        <span class="n">remainNeedPre</span> <span class="o">=</span> <span class="n">pot_Res_Domestic</span> <span class="o">+</span> <span class="n">pot_Res_Livestock</span> <span class="o">+</span> <span class="n">pot_Res_Industry</span>

                        <span class="n">demand_Segment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                  <span class="n">npareatotal</span><span class="p">(</span><span class="n">remainNeedPre</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span><span class="p">),</span>
                                                  <span class="mi">0</span><span class="p">)</span>  <span class="c1"># [M3]</span>

                        <span class="c1"># Reservoir associated with the Command Area</span>
                        <span class="c1">#</span>
                        <span class="c1"># If there is more than one reservoir in a command area, the storage of the reservoir with</span>
                        <span class="c1"># maximum storage in this time-step is chosen. The map resStorageTotal_alloc holds this</span>
                        <span class="c1"># maximum reservoir storage within a command area in all cells within that command area</span>
                        
                        <span class="c1"># filter reservoirs so only non-restricted res. are acccounted for</span>
                        <span class="n">ReservoirsThatAreCurrentlyReservoirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyTypCTemp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> \
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyTypCTemp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                        <span class="n">ReservoirsThatAreCurrentlyReservoirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">resId_restricted</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> \
                            <span class="n">ReservoirsThatAreCurrentlyReservoirs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                        <span class="n">reservoirStorageM3</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="c1"># np.put(reservoirStorageM3, self.var.decompress_LR, self.var.reservoirStorageM3C)</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">reservoirStorageM3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span> <span class="n">ReservoirsThatAreCurrentlyReservoirs</span><span class="p">)</span>

                        <span class="n">resStorageTotal_alloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                         <span class="n">npareamaximum</span><span class="p">(</span><span class="n">reservoirStorageM3</span><span class="p">,</span>
                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># [M3]</span>

                        <span class="c1"># In the map resStorageTotal_allocC, the maximum storage from each allocation segment is held</span>
                        <span class="c1"># in all reservoir cells within that allocation segment. We now correct to remove the</span>
                        <span class="c1"># reservoirs that are not this maximum-storage-reservoir for the command area.</span>
                        <span class="n">resStorageTotal_allocC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="n">resStorageTotal_alloc</span><span class="p">)</span>
                        <span class="n">resStorageTotal_allocC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">resStorageTotal_allocC</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span>
                                                             <span class="n">resStorageTotal_allocC</span><span class="p">)</span>

                        <span class="n">day_of_year</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">dateVar</span><span class="p">[</span><span class="s1">&#39;currDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span>
                        
                            
                        <span class="k">if</span> <span class="s1">&#39;Reservoir_releases&#39;</span> <span class="ow">in</span> <span class="n">binding</span><span class="p">:</span>
                            <span class="c1"># resStorage_maxFracForIrrigation = 0.5 + globals.inZero.copy()</span>
                            <span class="n">resStorage_maxFracForIrrigation</span> <span class="o">=</span> <span class="n">readnetcdf2</span><span class="p">(</span><span class="s1">&#39;Reservoir_releases&#39;</span><span class="p">,</span> <span class="n">day_of_year</span><span class="p">,</span>
                                                                          <span class="n">useDaily</span><span class="o">=</span><span class="s1">&#39;DOY&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Fraction of Volume&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">resStorage_maxFracForIrrigation</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                        <span class="c1"># resStorage_maxFracForIrrigationC holds the fractional rules found for each reservoir,</span>
                        <span class="c1"># so we must null those that are not the maximum-storage reservoirs</span>
                        <span class="n">resStorage_maxFracForIrrigationC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span>
                                                                       <span class="n">resStorage_maxFracForIrrigation</span><span class="p">)</span>
                        <span class="n">resStorage_maxFracForIrrigationC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                            <span class="n">resStorageTotal_allocC</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span> <span class="n">resStorage_maxFracForIrrigationC</span><span class="p">)</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">resStorage_maxFracForIrrigation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span>
                               <span class="n">resStorage_maxFracForIrrigationC</span><span class="p">)</span>

                        <span class="n">resStorage_maxFracForIrrigation_CA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                                      <span class="n">npareamaximum</span><span class="p">(</span><span class="n">resStorage_maxFracForIrrigation</span><span class="p">,</span>
                                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span><span class="p">),</span>
                                                                      <span class="mi">0</span><span class="p">)</span>

                       

                        <span class="n">act_bigLakeResAbst_alloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                            <span class="n">resStorage_maxFracForIrrigation_CA</span> <span class="o">*</span> <span class="n">resStorageTotal_alloc</span><span class="p">,</span>
                            <span class="n">demand_Segment</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Water_conveyance_efficiency</span><span class="p">)</span>  <span class="c1"># [M3]</span>

                        <span class="c1"># fraction of water abstracted versus water available for total segment reservoir volumes</span>
                        <span class="n">ResAbstractFactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">resStorageTotal_alloc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                     <span class="n">divideValues</span><span class="p">(</span><span class="n">act_bigLakeResAbst_alloc</span><span class="p">,</span> <span class="n">resStorageTotal_alloc</span><span class="p">),</span>
                                                     <span class="mi">0</span><span class="p">)</span>
                        <span class="c1"># Compressed version needs to be corrected as above</span>
                        <span class="n">ResAbstractFactorC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="n">ResAbstractFactor</span><span class="p">)</span>
                        <span class="n">ResAbstractFactorC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">resStorageTotal_allocC</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span>
                                                         <span class="n">ResAbstractFactorC</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeStorageC</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeVolumeM3C</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorageC</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">abstractedLakeReservoirM3C</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">abstractedLakeReservoirM3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">abstractedLakeReservoirM3C</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorage</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorage</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorageC</span><span class="p">)</span>

                        <span class="n">metRemainSegment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">demand_Segment</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                    <span class="n">divideValues</span><span class="p">(</span><span class="n">act_bigLakeResAbst_alloc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Water_conveyance_efficiency</span><span class="p">,</span>
                                                                 <span class="n">demand_Segment</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># by definition &lt;= 1</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst</span> <span class="o">+=</span> <span class="n">remainNeedPre</span> <span class="o">*</span> <span class="n">metRemainSegment</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span> <span class="o">+=</span> <span class="n">remainNeedPre</span> <span class="o">*</span> <span class="n">metRemainSegment</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_ResAbst</span> <span class="o">=</span> <span class="n">remainNeedPre</span> <span class="o">*</span> <span class="n">metRemainSegment</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Domestic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_ResAbst</span><span class="p">,</span>
                                                           <span class="n">pot_Res_Domestic</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Livestock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_ResAbst</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Domestic</span><span class="p">,</span>
                                                            <span class="n">pot_Res_Livestock</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Industry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_ResAbst</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Livestock</span><span class="p">,</span>
                            <span class="n">pot_Res_Industry</span><span class="p">)</span>

                    <span class="c1"># If sector- and source-specific abstractions are activated, then domestic, industrial, and</span>
                    <span class="c1">#  livestock demands were attempted to be satisfied in the previous step. Otherwise, total demands</span>
                    <span class="c1">#  not satisfied by previous sources is attempted.</span>
                    <span class="c1">#</span>
                    <span class="c1"># The remaining demand within each command area [M3] is put into a map where each cell in the</span>
                    <span class="c1"># command area holds this total demand</span>
                    <span class="n">demand_Segment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                              <span class="n">npareatotal</span><span class="p">(</span><span class="n">remainNeed2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span><span class="p">),</span>
                                              <span class="mi">0</span><span class="p">)</span>  <span class="c1"># [M3]</span>

                    <span class="c1">## Reservoir associated with the Command Area</span>
                    <span class="c1">#</span>
                    <span class="c1"># If there is more than one reservoir in a command area,</span>
                    <span class="c1">#   the storage of the reservoir with maximum storage in this time-step is chosen.</span>
                    <span class="c1"># The map resStorageTotal_alloc holds this maximum reservoir storage</span>
                    <span class="c1">#   within a command area in all cells within that command area</span>

                    <span class="n">ReservoirsThatAreCurrentlyReservoirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterBodyTypCTemp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">reservoirStorageM3</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="c1"># np.put(reservoirStorageM3, self.var.decompress_LR, self.var.reservoirStorageM3C)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">reservoirStorageM3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span> <span class="n">ReservoirsThatAreCurrentlyReservoirs</span><span class="p">)</span>

                    <span class="n">resStorageTotal_alloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                     <span class="n">npareamaximum</span><span class="p">(</span><span class="n">reservoirStorageM3</span><span class="p">,</span>
                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># [M3]</span>

                    <span class="c1"># In the map resStorageTotal_allocC, the maximum storage from each allocation segment</span>
                    <span class="c1">#   is held in all reservoir cells within that allocation segment.</span>
                    <span class="c1"># We now correct to remove the reservoirs</span>
                    <span class="c1">#   that are not this maximum-storage-reservoir for the command area.</span>
                    <span class="n">resStorageTotal_allocC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="n">resStorageTotal_alloc</span><span class="p">)</span>
                    <span class="n">resStorageTotal_allocC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">resStorageTotal_allocC</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span>
                                                         <span class="n">resStorageTotal_allocC</span><span class="p">)</span>

                    <span class="c1"># The rules for the maximum amount of water to be released for irrigation</span>
                    <span class="c1">#   are found for the chosen maximum-storage reservoir in each command area</span>
                    <span class="n">day_of_year</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">dateVar</span><span class="p">[</span><span class="s1">&#39;currDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span>

                    <span class="k">if</span> <span class="s1">&#39;Reservoir_releases&#39;</span> <span class="ow">in</span> <span class="n">binding</span><span class="p">:</span>
                        <span class="n">resStorage_maxFracForIrrigation</span> <span class="o">=</span> <span class="n">readnetcdf2</span><span class="p">(</span><span class="s1">&#39;Reservoir_releases&#39;</span><span class="p">,</span> <span class="n">day_of_year</span><span class="p">,</span>
                                                                      <span class="n">useDaily</span><span class="o">=</span><span class="s1">&#39;DOY&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Fraction of Volume&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">resStorage_maxFracForIrrigation</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">+</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                    <span class="c1"># resStorage_maxFracForIrrigationC holds the fractional rules found for each reservoir,</span>
                    <span class="c1">#   so we must null those that are not the maximum-storage reservoirs</span>
                    <span class="n">resStorage_maxFracForIrrigationC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span>
                                                                   <span class="n">resStorage_maxFracForIrrigation</span><span class="p">)</span>
                    <span class="n">resStorage_maxFracForIrrigationC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                        <span class="n">resStorageTotal_allocC</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span> <span class="n">resStorage_maxFracForIrrigationC</span><span class="p">)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">resStorage_maxFracForIrrigation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span> <span class="n">resStorage_maxFracForIrrigationC</span><span class="p">)</span>

                    <span class="n">resStorage_maxFracForIrrigation_CA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                                  <span class="n">npareamaximum</span><span class="p">(</span><span class="n">resStorage_maxFracForIrrigation</span><span class="p">,</span>
                                                                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoir_command_areas</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

                    

                    <span class="n">act_bigLakeResAbst_alloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">resStorage_maxFracForIrrigation_CA</span> <span class="o">*</span> <span class="n">resStorageTotal_alloc</span><span class="p">,</span>
                                                          <span class="n">demand_Segment</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Water_conveyance_efficiency</span><span class="p">)</span>  <span class="c1"># [M3]</span>

                    <span class="n">ResAbstractFactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">resStorageTotal_alloc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                 <span class="n">divideValues</span><span class="p">(</span><span class="n">act_bigLakeResAbst_alloc</span><span class="p">,</span> <span class="n">resStorageTotal_alloc</span><span class="p">),</span>
                                                 <span class="mi">0</span><span class="p">)</span>
                    <span class="c1"># fraction of water abstracted versus water available for total segment reservoir volumes</span>
                    <span class="c1"># Compressed version needs to be corrected as above</span>
                    <span class="n">ResAbstractFactorC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="n">ResAbstractFactor</span><span class="p">)</span>
                    <span class="n">ResAbstractFactorC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">resStorageTotal_allocC</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span><span class="p">,</span>
                                                     <span class="n">ResAbstractFactorC</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeStorageC</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeVolumeM3C</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorageC</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">abstractedLakeReservoirM3C</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">reservoirStorageM3C</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">abstractedLakeReservoirM3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">abstractedLakeReservoirM3C</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorage</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorage</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">lakeResStorageC</span><span class="p">)</span>

                    <span class="n">metRemainSegment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">demand_Segment</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                <span class="n">divideValues</span><span class="p">(</span><span class="n">act_bigLakeResAbst_alloc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Water_conveyance_efficiency</span><span class="p">,</span>
                                                             <span class="n">demand_Segment</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># by definition &lt;= 1</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakageC_daily</span> <span class="o">=</span> <span class="n">resStorageTotal_allocC</span> <span class="o">*</span> <span class="n">ResAbstractFactorC</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">compress_LR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Water_conveyance_efficiency</span><span class="p">))</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakage</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakage</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakageC_daily</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakage_wwtC_daily</span><span class="p">)</span>

                    <span class="c1"># self.var.leakageC += self.var.leakageC_daily</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakageCanalsC_M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canalsAreaC</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakageC_daily</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakage_wwtC_daily</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canalsAreaC</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="c1"># Without this, npareamaximum uses the historical maximum</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakageCanals_M</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakageCanals_M</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">decompress_LR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakageCanalsC_M</span><span class="p">)</span>  <span class="c1"># good</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakageCanals_M</span> <span class="o">=</span> <span class="n">npareamaximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">leakageCanals_M</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">canals</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst</span> <span class="o">+=</span> <span class="n">remainNeed2</span> <span class="o">*</span> <span class="n">metRemainSegment</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span> <span class="o">+=</span> <span class="n">remainNeed2</span> <span class="o">*</span> <span class="n">metRemainSegment</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_ResAbst</span> <span class="o">+=</span> <span class="n">remainNeed2</span> <span class="o">*</span> <span class="n">metRemainSegment</span>

                    <span class="c1">## End of using_reservoir_command_areas</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                            <span class="n">remainNeed2</span> <span class="o">*</span> <span class="n">metRemainSegment</span><span class="p">,</span>
                            <span class="n">pot_Res_Irrigation</span><span class="p">)</span>

                <span class="c1"># B</span>

            <span class="c1"># remaining is taken from groundwater if possible</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                <span class="n">pot_GW_Domestic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Domestic</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic</span> <span class="o">-</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Domestic</span><span class="p">)</span>
                    
                <span class="n">pot_GW_Livestock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Livestock</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock</span> <span class="o">-</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Livestock</span><span class="p">)</span>

                <span class="n">pot_GW_Industry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Industry</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Industry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Industry</span> <span class="o">-</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Industry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Industry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Industry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Industry</span><span class="p">)</span>

                <span class="n">pot_GW_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Irrigation</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span><span class="p">,</span>                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Irrigation</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Irrigation</span> <span class="o">-</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Irrigation</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Irrigation</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Irrigation</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Irrigation</span><span class="p">)</span>


                <span class="k">if</span> <span class="s1">&#39;irrigation_agent_GW_request_month_m3&#39;</span> <span class="ow">in</span> <span class="n">binding</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">activate_irrigation_agents</span><span class="p">:</span>
                    <span class="n">pot_GW_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">pot_GW_Irrigation</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrWithdrawalGW_max</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">InvCellArea</span><span class="p">)</span>


                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_GroundwaterAbstract</span> <span class="o">=</span> <span class="n">pot_GW_Domestic</span> <span class="o">+</span> <span class="n">pot_GW_Livestock</span> <span class="o">+</span> <span class="n">pot_GW_Industry</span> <span class="o">+</span> <span class="n">pot_GW_Irrigation</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_GroundwaterAbstract</span> <span class="o">=</span> <span class="n">totalDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">modflow</span><span class="p">:</span>
                <span class="c1"># if available storage is too low, no pumping in this cell (defined in transient module)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">groundwater_storage_available</span> <span class="o">&gt;</span> <span class="p">(</span>
                        <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">availableGWStorageFraction</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwstorage_full</span><span class="p">,</span>
                                                            <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">groundwater_storage_available</span><span class="p">,</span>
                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_GroundwaterAbstract</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlStorGroundwater</span><span class="p">,</span>
                                                                             <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_GroundwaterAbstract</span><span class="p">))</span>

            <span class="c1"># if limitAbstraction from groundwater is True</span>
            <span class="c1"># fossil gwAbstraction and water demand may be reduced</span>
            <span class="c1"># variable to reduce/limit groundwater abstraction (&gt; 0 if limitAbstraction = True)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                <span class="c1"># A</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Domestic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span><span class="p">,</span> <span class="n">pot_GW_Domestic</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Livestock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Domestic</span><span class="p">,</span>
                                                   <span class="n">pot_GW_Livestock</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Industry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Livestock</span><span class="p">,</span>
                    <span class="n">pot_GW_Industry</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Industry</span><span class="p">,</span>
                    <span class="n">pot_GW_Irrigation</span><span class="p">)</span>

                <span class="n">unmet_Domestic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">domesticDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic</span> <span class="o">-</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Domestic</span>
                <span class="n">unmet_Livestock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">livestockDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock</span> <span class="o">-</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Livestock</span>
                <span class="n">unmet_Industry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">industryDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Industry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Industry</span> <span class="o">-</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Industry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Industry</span>  <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Industry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Industry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Industry</span>
                <span class="n">unmet_Irrigation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Irrigation</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Irrigation</span> <span class="o">-</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Irrigation</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Industry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Irrigation</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Irrigation</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Irrigation</span>

            <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;limitAbstraction&#39;</span><span class="p">):</span>
                <span class="c1"># real surface water abstraction can be lower, because not all demand can be done from surface water</span>
                <span class="n">act_swAbstractionFraction</span> <span class="o">=</span> <span class="n">divideValues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span><span class="p">,</span> <span class="n">totalDemand</span><span class="p">)</span>
                <span class="c1"># Fossil groundwater abstraction is not allowed</span>
                <span class="c1"># allocation rule here: domestic&amp; industry &gt; irrigation &gt; paddy</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrWithdrawal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Domestic</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Livestock</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Industry</span> <span class="o">+</span> \
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Industry</span> <span class="o">+</span> \
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Domestic</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Livestock</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Industry</span> <span class="o">+</span> \
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Domestic</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Livestock</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Industry</span> <span class="o">+</span> \
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Domestic</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Livestock</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Industry</span> <span class="o">+</span> \
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Domestic</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Livestock</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Industry</span> <span class="o">+</span> \
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Domestic</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Livestock</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Industry</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Irrigation</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Irrigation</span> <span class="o">+</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Irrigation</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Irrigation</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Irrigation</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Irrigation</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Irrigation</span>
                    <span class="c1"># Currently wastewater and desalination are accounted as surface water</span>
                    <span class="n">act_irrWithdrawalSW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Irrigation</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Irrigation</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Irrigation</span> <span class="o">+</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Irrigation</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Irrigation</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Irrigation</span>
                    <span class="n">act_irrWithdrawalGW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Irrigation</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrNonpaddyWithdrawal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawal</span><span class="p">,</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrDemand</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrPaddyWithdrawal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawal</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrNonpaddyWithdrawal</span>

                    <span class="n">act_gw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span><span class="p">:</span>  <span class="c1"># all demands are taken into account</span>
                    <span class="c1"># non-irrgated water demand: adjusted (and maybe increased) by gwabstration factor if</span>
                    <span class="c1"># non-irrgated water demand is higher than actual growndwater abstraction (what is needed and</span>
                    <span class="c1"># what is stored in gw)</span>
                    <span class="n">act_nonIrrWithdrawalGW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrDemand</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">act_swAbstractionFraction</span><span class="p">)</span>
                    <span class="n">act_nonIrrWithdrawalGW</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">act_nonIrrWithdrawalGW</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span><span class="p">,</span> <span class="n">act_nonIrrWithdrawalGW</span><span class="p">)</span>
                    <span class="n">act_nonIrrWithdrawalSW</span> <span class="o">=</span> <span class="n">act_swAbstractionFraction</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrDemand</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrWithdrawal</span> <span class="o">=</span> <span class="n">act_nonIrrWithdrawalSW</span> <span class="o">+</span> <span class="n">act_nonIrrWithdrawalGW</span>

                    <span class="c1"># irrigated water demand:</span>
                    <span class="n">act_irrWithdrawalGW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">act_swAbstractionFraction</span><span class="p">)</span>
                    <span class="n">act_irrWithdrawalGW</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span> <span class="o">-</span> <span class="n">act_nonIrrWithdrawalGW</span><span class="p">,</span>
                                                     <span class="n">act_irrWithdrawalGW</span><span class="p">)</span>
                    <span class="n">act_irrWithdrawalSW</span> <span class="o">=</span> <span class="n">act_swAbstractionFraction</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawal</span> <span class="o">=</span> <span class="n">act_irrWithdrawalSW</span> <span class="o">+</span> <span class="n">act_irrWithdrawalGW</span>
                    <span class="c1"># (nonpaddy)</span>
                    <span class="n">act_irrnonpaddyGW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">act_swAbstractionFraction</span><span class="p">)</span> <span class="o">*</span> \
                                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrDemand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">act_irrnonpaddyGW</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span> <span class="o">-</span> <span class="n">act_nonIrrWithdrawalGW</span><span class="p">,</span>
                                                   <span class="n">act_irrnonpaddyGW</span><span class="p">)</span>
                    <span class="n">act_irrnonpaddySW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">act_swAbstractionFraction</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrDemand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrNonpaddyWithdrawal</span> <span class="o">=</span> <span class="n">act_irrnonpaddySW</span> <span class="o">+</span> <span class="n">act_irrnonpaddyGW</span>
                    <span class="c1"># (paddy)</span>
                    <span class="n">act_irrpaddyGW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">act_swAbstractionFraction</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrDemand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">act_irrpaddyGW</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span> <span class="o">-</span> <span class="n">act_nonIrrWithdrawalGW</span> <span class="o">-</span> <span class="n">act_irrnonpaddyGW</span><span class="p">,</span> <span class="n">act_irrpaddyGW</span><span class="p">)</span>
                    <span class="n">act_irrpaddySW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">act_swAbstractionFraction</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrDemand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrPaddyWithdrawal</span> <span class="o">=</span> <span class="n">act_irrpaddySW</span> <span class="o">+</span> <span class="n">act_irrpaddyGW</span>

                    <span class="n">act_gw</span> <span class="o">=</span> <span class="n">act_nonIrrWithdrawalGW</span> <span class="o">+</span> <span class="n">act_irrWithdrawalGW</span>
                    <span class="c1"># This should be equal to self.var.nonFossilGroundwaterAbs?</span>


                <span class="k">else</span><span class="p">:</span>  <span class="c1"># only irrigation is considered</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrWithdrawal</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                    <span class="c1"># irrigated water demand:</span>
                    <span class="n">act_irrWithdrawalGW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">act_swAbstractionFraction</span><span class="p">)</span>
                    <span class="n">act_irrWithdrawalGW</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span><span class="p">,</span> <span class="n">act_irrWithdrawalGW</span><span class="p">)</span>
                    <span class="n">act_irrWithdrawalSW</span> <span class="o">=</span> <span class="n">act_swAbstractionFraction</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawal</span> <span class="o">=</span> <span class="n">act_irrWithdrawalSW</span> <span class="o">+</span> <span class="n">act_irrWithdrawalGW</span>
                    <span class="c1"># (nonpaddy)</span>
                    <span class="n">act_irrnonpaddyGW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">act_swAbstractionFraction</span><span class="p">)</span> <span class="o">*</span> \
                                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrDemand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">act_irrnonpaddyGW</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span><span class="p">,</span> <span class="n">act_irrnonpaddyGW</span><span class="p">)</span>
                    <span class="n">act_irrnonpaddySW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">act_swAbstractionFraction</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrDemand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrNonpaddyWithdrawal</span> <span class="o">=</span> <span class="n">act_irrnonpaddySW</span> <span class="o">+</span> <span class="n">act_irrnonpaddyGW</span>
                    <span class="c1"># (paddy)</span>
                    <span class="n">act_irrpaddyGW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">act_swAbstractionFraction</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrDemand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">act_irrpaddyGW</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span> <span class="o">-</span> <span class="n">act_irrnonpaddyGW</span><span class="p">,</span> <span class="n">act_irrpaddyGW</span><span class="p">)</span>
                    <span class="n">act_irrpaddySW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">act_swAbstractionFraction</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrDemand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrPaddyWithdrawal</span> <span class="o">=</span> <span class="n">act_irrpaddySW</span> <span class="o">+</span> <span class="n">act_irrpaddyGW</span>

                    <span class="n">act_gw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">act_irrWithdrawalGW</span><span class="p">)</span>

                <span class="c1"># calculate act_ water demand, because irr demand has still demand from previous day included</span>
                <span class="c1"># if the demand from previous day is not fulfilled it is taken to the next day and so on</span>
                <span class="c1"># if we do not correct we double account each day the demand from previous days</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrPaddyDemand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrPaddyDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemandPaddy</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrNonpaddyDemand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrNonpaddyDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemandNonpaddy</span><span class="p">)</span>

                <span class="c1"># unmet is either pot_GroundwaterAbstract - self.var.nonFossilGroundwaterAbs or demand - withdrawal</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span><span class="p">:</span>  <span class="c1"># all demands are taken into account</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemand</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawal</span><span class="p">)</span> <span class="o">+</span> \
                                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrWithdrawal</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># only irrigation is considered</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemand</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawal</span><span class="p">)</span> <span class="o">-</span> \
                                           <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrWithdrawal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemandPaddy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrPaddyDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrPaddyDemand</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemandNonpaddy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrNonpaddyDemand</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrNonpaddyDemand</span>


            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This is the case when using ModFlow coupling (limitation imposed previously)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">modflow</span><span class="p">:</span>
                    <span class="c1"># This is the case when using ModFlow coupling (limitation imposed previously)</span>
                    <span class="c1"># part of the groundwater demand unsatisfied</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_GroundwaterAbstract</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span><span class="p">:</span>  <span class="c1"># all demands are taken into account</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrWithdrawal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrDemand</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span><span class="p">)</span>

                    <span class="n">act_gw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Fossil groundwater abstractions are allowed (act = pot)</span>
                    <span class="k">if</span> <span class="s1">&#39;zonal_abstraction&#39;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;zonal_abstraction&#39;</span><span class="p">):</span>

                            <span class="c1"># using allocation from abstraction zone</span>
                            <span class="c1"># this might be a regualr grid e.g. 2x2 for 0.5 deg</span>
                            <span class="n">left_sf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlChannelStorageM</span>  <span class="c1"># already removed - self.var.act_channelAbst</span>
                            <span class="c1"># sum demand, surface water - local used, groundwater - local use, not satisfied for allocation zone</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                                <span class="n">unmetChannel_Domestic</span> <span class="o">=</span> <span class="n">pot_Channel_Domestic</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic</span>
                                <span class="n">unmetChannel_Livestock</span> <span class="o">=</span> <span class="n">pot_Channel_Livestock</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock</span>
                                <span class="n">unmetChannel_Industry</span> <span class="o">=</span> <span class="n">pot_Channel_Industry</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Industry</span>
                                <span class="n">unmetChannel_Irrigation</span> <span class="o">=</span> <span class="n">pot_Channel_Irrigation</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Irrigation</span>

                                <span class="n">pot_Channel_Domestic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">unmetChannel_Domestic</span><span class="p">,</span> <span class="n">unmet_Domestic</span><span class="p">)</span>
                                <span class="n">pot_Channel_Livestock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">unmetChannel_Livestock</span><span class="p">,</span> <span class="n">unmet_Livestock</span><span class="p">)</span>
                                <span class="n">pot_Channel_Industry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">unmetChannel_Industry</span><span class="p">,</span> <span class="n">unmet_Industry</span><span class="p">)</span>
                                <span class="n">pot_Channel_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">unmetChannel_Irrigation</span><span class="p">,</span> <span class="n">unmet_Irrigation</span><span class="p">)</span>

                                <span class="n">unmet_Channel</span> <span class="o">=</span> <span class="n">pot_Channel_Domestic</span> <span class="o">+</span> <span class="n">pot_Channel_Livestock</span> \
                                                <span class="o">+</span> <span class="n">pot_Channel_Industry</span> <span class="o">+</span> <span class="n">pot_Channel_Irrigation</span>

                                <span class="n">zoneDemand</span> <span class="o">=</span> <span class="n">npareatotal</span><span class="p">(</span><span class="n">unmet_Channel</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">allocation_zone</span><span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">zoneDemand</span> <span class="o">=</span> <span class="n">npareatotal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemand</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">allocation_zone</span><span class="p">)</span>

                            <span class="n">zone_sf_avail</span> <span class="o">=</span> <span class="n">npareatotal</span><span class="p">(</span><span class="n">left_sf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">allocation_zone</span><span class="p">)</span>

                            <span class="c1"># zone abstraction is minimum of availability and demand</span>
                            <span class="n">zone_sf_abstraction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">zoneDemand</span><span class="p">,</span> <span class="n">zone_sf_avail</span><span class="p">)</span>
                            <span class="c1"># water taken from surface zone and allocated to cell demand</span>
                            <span class="n">cell_sf_abstraction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">divideValues</span><span class="p">(</span><span class="n">left_sf</span><span class="p">,</span> <span class="n">zone_sf_avail</span><span class="p">)</span> <span class="o">*</span> <span class="n">zone_sf_abstraction</span><span class="p">)</span>
                            <span class="n">cell_sf_allocation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">divideValues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemand</span><span class="p">,</span>
                                                                             <span class="n">zoneDemand</span><span class="p">)</span> <span class="o">*</span> <span class="n">zone_sf_abstraction</span><span class="p">)</span>

                            <span class="c1"># sum up with other abstraction</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span> <span class="o">+</span> <span class="n">cell_sf_abstraction</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_channelAbst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_channelAbst</span> <span class="o">+</span> <span class="n">cell_sf_abstraction</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic_fromZone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">cell_sf_abstraction</span><span class="p">,</span> <span class="n">pot_Channel_Domestic</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic_fromZone</span>

                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock_fromZone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                    <span class="n">cell_sf_abstraction</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic_fromZone</span><span class="p">,</span>
                                    <span class="n">pot_Channel_Livestock</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock_fromZone</span>

                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Industry_fromZone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                    <span class="n">cell_sf_abstraction</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic_fromZone</span> <span class="o">-</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock_fromZone</span><span class="p">,</span>
                                    <span class="n">pot_Channel_Industry</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Industry</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Industry_fromZone</span>

                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Irrigation_fromZone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                    <span class="n">cell_sf_abstraction</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic_fromZone</span> <span class="o">-</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock_fromZone</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Industry_fromZone</span><span class="p">,</span>
                                    <span class="n">pot_Channel_Irrigation</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Irrigation</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Irrigation_fromZone</span>

                            <span class="c1"># new potential groundwater abstraction</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_GroundwaterAbstract</span> <span class="o">=</span> \
                                <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_GroundwaterAbstract</span> <span class="o">-</span> <span class="n">cell_sf_allocation</span><span class="p">)</span>

                            <span class="n">left_gw_demand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_GroundwaterAbstract</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span><span class="p">)</span>
                            <span class="n">left_gw_avail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">readAvlStorGroundwater</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span>
                            <span class="n">zone_gw_avail</span> <span class="o">=</span> <span class="n">npareatotal</span><span class="p">(</span><span class="n">left_gw_avail</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">allocation_zone</span><span class="p">)</span>

                            <span class="c1"># for groundwater substract demand which is fulfilled by surface zone, calc abstraction and what</span>
                            <span class="c1"># is left. zone_gw_demand = npareatotal(left_gw_demand, self.var.allocation_zone)</span>
                            <span class="n">zone_gw_demand</span> <span class="o">=</span> <span class="n">zoneDemand</span> <span class="o">-</span> <span class="n">zone_sf_abstraction</span>
                            <span class="n">zone_gw_abstraction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">zone_gw_demand</span><span class="p">,</span> <span class="n">zone_gw_avail</span><span class="p">)</span>
                            <span class="c1"># zone_unmetdemand = np.maximum(0., zone_gw_demand - zone_gw_abstraction)</span>

                            <span class="c1"># water taken from groundwater zone and allocated to cell demand</span>
                            <span class="n">cell_gw_abstraction</span> <span class="o">=</span> \
                                <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">divideValues</span><span class="p">(</span><span class="n">left_gw_avail</span><span class="p">,</span> <span class="n">zone_gw_avail</span><span class="p">)</span> <span class="o">*</span> <span class="n">zone_gw_abstraction</span><span class="p">)</span>
                            <span class="n">cell_gw_allocation</span> <span class="o">=</span> \
                                <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">divideValues</span><span class="p">(</span><span class="n">left_gw_demand</span><span class="p">,</span> <span class="n">zone_gw_demand</span><span class="p">)</span> <span class="o">*</span> <span class="n">zone_gw_abstraction</span><span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">left_gw_demand</span> <span class="o">-</span> <span class="n">cell_gw_allocation</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span> <span class="o">+</span> <span class="n">cell_gw_abstraction</span>

                            <span class="c1"># UNDER CONSTRUCTION</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Domestic_fromZone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span><span class="p">,</span> <span class="n">pot_GW_Domestic</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Domestic</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Domestic_fromZone</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Livestock_fromZone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Domestic_fromZone</span><span class="p">,</span>
                                    <span class="n">pot_GW_Livestock</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Livestock</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Livestock_fromZone</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Industry_fromZone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span> <span class="o">-</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Domestic_fromZone</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Livestock_fromZone</span><span class="p">,</span>
                                    <span class="n">pot_GW_Industry</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Industry</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Industry_fromZone</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Irrigation_fromZone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Domestic_fromZone</span> <span class="o">-</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Livestock_fromZone</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Industry_fromZone</span><span class="p">,</span>
                                    <span class="n">pot_GW_Irrigation</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Irrigation</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Irrigation_fromZone</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                            <span class="c1"># end of zonal abstraction</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_GroundwaterAbstract</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Domestic</span> <span class="o">=</span> <span class="n">pot_GW_Domestic</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Industry</span> <span class="o">=</span> <span class="n">pot_GW_Industry</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Livestock</span> <span class="o">=</span> <span class="n">pot_GW_Livestock</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Irrigation</span> <span class="o">=</span> <span class="n">pot_GW_Irrigation</span>


                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span><span class="p">:</span>  <span class="c1"># all demands are taken into account</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrWithdrawal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrDemand</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span><span class="p">)</span>

                    <span class="n">act_gw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pot_GroundwaterAbstract</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrNonpaddyWithdrawal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrDemand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrPaddyWithdrawal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrDemand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrNonpaddyDemand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrNonpaddyWithdrawal</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrPaddyDemand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrPaddyWithdrawal</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1">## End of limit extraction if, then</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrConsumption</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">divideValues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrPaddyWithdrawal</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">efficiencyPaddy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrConsumption</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">divideValues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrNonpaddyWithdrawal</span><span class="p">,</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">efficiencyNonpaddy</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">modflow</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_pumping</span><span class="p">:</span>  <span class="c1"># pumping demand is sent to ModFlow (used in transient module)</span>
                    <span class="c1"># modfPumpingM is initialized every &quot;modflow_timestep&quot; in &quot;groundwater_modflow/transient.py&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">modfPumpingM</span> <span class="o">+=</span> <span class="n">act_gw</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Pumping_daily</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">act_gw</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">PumpingM3_daily</span> <span class="o">=</span> <span class="n">act_gw</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_domWithdrawal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Domestic</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Domestic</span> <span class="o">+</span> \
                                             <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Domestic</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Domestic</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Domestic</span> <span class="o">+</span> \
                                             <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Domestic</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Domestic</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_livWithdrawal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Livestock</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Livestock</span> <span class="o">+</span> \
                                             <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Livestock</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Livestock</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Livestock</span> <span class="o">+</span> \
                                             <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Livestock</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Livestock</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_indWithdrawal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Channel_Industry</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lift_Industry</span> <span class="o">+</span> \
                                             <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Desal_Industry</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwt_Industry</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Lake_Industry</span> <span class="o">+</span> \
                                             <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">Res_Industry</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">GW_Industry</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_indConsumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ind_efficiency</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_indWithdrawal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_domConsumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">dom_efficiency</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_domWithdrawal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_livConsumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">liv_efficiency</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_livWithdrawal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrConsumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_domConsumption</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_indConsumption</span> <span class="o">+</span> \
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_livConsumption</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span><span class="p">:</span>  <span class="c1"># all demands are taken into account</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_indWithdrawal</span> <span class="o">=</span> <span class="n">frac_industry</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrWithdrawal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_domWithdrawal</span> <span class="o">=</span> <span class="n">frac_domestic</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrWithdrawal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_livWithdrawal</span> <span class="o">=</span> <span class="n">frac_livestock</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrWithdrawal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_indConsumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ind_efficiency</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_indWithdrawal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_domConsumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">dom_efficiency</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_domWithdrawal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_livConsumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">liv_efficiency</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_livWithdrawal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrConsumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_domConsumption</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_indConsumption</span> <span class="o">+</span> \
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_livConsumption</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># only irrigation is considered</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrConsumption</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalIrrConsumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrConsumption</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> \
                                               <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrConsumption</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_paddyConsumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrConsumption</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonpaddyConsumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrConsumption</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span><span class="p">:</span>  <span class="c1"># all demands are taken into account</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalWaterDemand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrDemand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span>
                    <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrDemand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrDemand</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalWaterWithdrawal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrWithdrawal</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawal</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalWaterConsumption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrConsumption</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalIrrConsumption</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># only irrigation is considered</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalWaterDemand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrDemand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">fracVegCover</span><span class="p">[</span>
                    <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrDemand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalWaterWithdrawal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawal</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalWaterConsumption</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalIrrConsumption</span><span class="p">)</span>

            <span class="c1"># --- calculate return flow</span>
            <span class="c1"># Sum up loss - difference between withdrawn and consumed - split into return flow and evaporation</span>
            <span class="n">sumIrrLoss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawal</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalIrrConsumption</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowIrr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnfractionIrr</span> <span class="o">*</span> <span class="n">sumIrrLoss</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">addtoevapotrans</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnfractionIrr</span><span class="p">)</span> <span class="o">*</span> <span class="n">sumIrrLoss</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">sectorSourceAbstractionFractions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrWithdrawal</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrConsumption</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span><span class="p">:</span>  <span class="c1"># all demands are taken into account</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrReturnFlowFraction</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrWithdrawal</span>

            <span class="c1"># limit return flow to not put all fossil groundwater back into the system, because it can lead to higher</span>
            <span class="c1"># river discharge than without water demand, as water is taken from fossil groundwater (out of system)</span>
            <span class="n">unmet_div_ww</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">divideValues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemand</span><span class="p">,</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalWaterWithdrawal</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemand</span><span class="p">))</span>

            <span class="c1"># &#39;fossil_water_treated_normally&#39; means that there is no lost fossil water</span>
            <span class="k">if</span> <span class="s1">&#39;fossil_water_treated_normally&#39;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;fossil_water_treated_normally&#39;</span><span class="p">):</span>
                    <span class="n">unmet_div_ww</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;limitAbstraction&#39;</span><span class="p">):</span>
                <span class="n">unmet_div_ww</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span><span class="p">:</span>  <span class="c1"># all demands are taken into account</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmet_lost</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowIrr</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">addtoevapotrans</span><span class="p">)</span> \
                                      <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">unmet_div_ww</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># only irrigation is considered</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmet_lost</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowIrr</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">addtoevapotrans</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">unmet_div_ww</span><span class="p">)</span>

            <span class="c1"># self.var.waterDemandLost = self.var.act_totalWaterConsumption + self.var.addtoevapotrans</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmet_lostirr</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowIrr</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">addtoevapotrans</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">unmet_div_ww</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span><span class="p">:</span>  <span class="c1"># all demands are taken into account</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmet_lostNonirr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">unmet_div_ww</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowIrr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowIrr</span> <span class="o">*</span> <span class="n">unmet_div_ww</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">addtoevapotrans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">addtoevapotrans</span> <span class="o">*</span> <span class="n">unmet_div_ww</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span><span class="p">:</span>  <span class="c1"># all demands are taken into account</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span> <span class="o">*</span> <span class="n">unmet_div_ww</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeWastewaterPits</span><span class="p">:</span>
                <span class="n">shareNonIrrReturnFlowToGW</span> <span class="o">=</span> <span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;pitLatrinShare&#39;</span> <span class="ow">in</span> <span class="n">binding</span><span class="p">:</span>
                    <span class="n">shareNonIrrReturnFlowToGW</span> <span class="o">=</span> <span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;pitLatrinShare&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">pitLatrinToGW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span> <span class="o">*</span> <span class="n">shareNonIrrReturnFlowToGW</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">shareNonIrrReturnFlowToGW</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeWastewater</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span><span class="p">:</span>  <span class="c1"># all demands are taken into account</span>
                <span class="c1">## create domestic, industry returnFlows</span>
                <span class="c1"># Simple implementation - not precise. Don&#39;t allow livestock returnFlow</span>
                <span class="c1"># better, is to calculate sectoral returnflows rate based on withdrawal, 1) for simple approahc 2) sourcesector fraction 3) unmetdemand - limitAbstraction = FALSE</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtEffluentsGenerated_domestic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="n">divideValues</span><span class="p">(</span><span class="n">frac_domestic</span><span class="p">,</span> <span class="n">frac_domestic</span> <span class="o">+</span> <span class="n">frac_industry</span><span class="p">)</span> <span class="c1"># [M3]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtEffluentsGenerated_industry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="n">divideValues</span><span class="p">(</span><span class="n">frac_industry</span><span class="p">,</span> <span class="n">frac_domestic</span> <span class="o">+</span> <span class="n">frac_industry</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtEffluentsGenerated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtEffluentsGenerated_domestic</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtEffluentsGenerated_industry</span>
            
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtSewerCollection_domestic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtColArea</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                       <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtEffluentsGenerated_domestic</span><span class="p">,</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtEffluentsGenerated_domestic</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtSewerCollection_industry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtColArea</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                       <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtEffluentsGenerated_industry</span><span class="p">,</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtEffluentsGenerated_industry</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span> 

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">wastewater_module</span><span class="o">.</span><span class="n">dynamic</span><span class="p">()</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtSewerCollection</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtSewerCollectedBySoruce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtEffluentsGenerated</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span>

            <span class="c1"># returnflow to river and to evapotranspiration</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span><span class="p">:</span>  <span class="c1"># all demands are taken into account</span>
                <span class="c1">#if self.var.includeWastewater:</span>
                    <span class="c1"># add uncollected wastewater</span>
                <span class="c1">#    uncollectedWWT = self.var.wwtSewerCollection * self.var.cellArea - \</span>
                <span class="c1">#                     self.var.wwtExportedCollected - self.var.wwtSewerCollected  # M3</span>
                <span class="c1">#    self.var.returnflowNonIrr += uncollectedWWT / self.var.cellArea</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnFlow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowIrr</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># only irrigation is considered</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnFlow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowIrr</span>

            <span class="c1"># add wastewater discharge to river to returnFlow - so they are sent to routing</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeWastewater</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnFlow</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">wwtOverflowOutM</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterabstraction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemand</span> <span class="o">+</span> \
                                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span>

            <span class="k">if</span> <span class="s1">&#39;adminSegments&#39;</span> <span class="ow">in</span> <span class="n">binding</span> <span class="ow">and</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;limitAbstraction&#39;</span><span class="p">):</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawalSW_month</span> <span class="o">+=</span> <span class="n">npareatotal</span><span class="p">(</span><span class="n">act_irrWithdrawalSW</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">,</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">adminSegments</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;irrigation_agent_SW_request_month_m3&#39;</span> <span class="ow">in</span> <span class="n">binding</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">activate_irrigation_agents</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Channel_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawalSW_month</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrWithdrawalSW_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Channel_Irrigation</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lift_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawalSW_month</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrWithdrawalSW_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lift_Irrigation</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lake_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawalSW_month</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrWithdrawalSW_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Lake_Irrigation</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Res_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawalSW_month</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrWithdrawalSW_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">swAbstractionFraction_Res_Irrigation</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ratio_irrWithdrawalSW_month</span> \
                        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawalSW_month</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrWithdrawalSW_max</span>

            <span class="k">if</span> <span class="s1">&#39;adminSegments&#39;</span> <span class="ow">in</span> <span class="n">binding</span> <span class="ow">and</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;limitAbstraction&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawalGW_month</span> <span class="o">+=</span> <span class="n">npareatotal</span><span class="p">(</span><span class="n">act_irrWithdrawalGW</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">cellArea</span><span class="p">,</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">adminSegments</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;irrigation_agent_GW_request_month_m3&#39;</span> <span class="ow">in</span> <span class="n">binding</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">activate_irrigation_agents</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Irrigation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawalGW_month</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrWithdrawalGW_max</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gwAbstractionFraction_Irrigation</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ratio_irrWithdrawalGW_month</span> \
                        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawalGW_month</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">irrWithdrawalGW_max</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relax_irrigation_agents</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dateVar</span><span class="p">[</span><span class="s1">&#39;currDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;irrigation_agent_SW_request_month_m3&#39;</span> <span class="ow">in</span> <span class="n">binding</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">activate_irrigation_agents</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxSWagent</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ratio_irrWithdrawalSW_month</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;irrigation_agent_GW_request_month_m3&#39;</span> <span class="ow">in</span> <span class="n">binding</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">activate_irrigation_agents</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxGWagent</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ratio_irrWithdrawalGW_month</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                <span class="c1"># This will decrease values that have increased, but not on agents that were never too large</span>
                <span class="k">if</span> <span class="n">dateVar</span><span class="p">[</span><span class="s1">&#39;currDate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">28</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;irrigation_agent_SW_request_month_m3&#39;</span> <span class="ow">in</span> <span class="n">binding</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">activate_irrigation_agents</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxSWagent</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxSWagent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                          <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ratio_irrWithdrawalSW_month</span> <span class="o">&gt;</span> <span class="mf">0.98</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                          <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;irrigation_agent_GW_request_month_m3&#39;</span> <span class="ow">in</span> <span class="n">binding</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">activate_irrigation_agents</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxGWagent</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">relaxGWagent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                                          <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ratio_irrWithdrawalGW_month</span> <span class="o">&gt;</span> <span class="mf">0.98</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                                          <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># ---------------------------------------------</span>
            <span class="c1"># testing</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">includeIndusDomesDemand</span><span class="p">:</span>  <span class="c1"># all demands are taken into account</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">waterbalance_module</span><span class="o">.</span><span class="n">waterBalanceCheck</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawal</span><span class="p">],</span>  <span class="c1"># In</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalIrrConsumption</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmet_lostirr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">addtoevapotrans</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowIrr</span><span class="p">],</span>  <span class="c1"># Out</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="s2">&quot;Waterdemand5a&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">waterbalance_module</span><span class="o">.</span><span class="n">waterBalanceCheck</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrWithdrawal</span><span class="p">],</span>  <span class="c1"># In</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrConsumption</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmet_lostNonirr</span><span class="p">],</span>  <span class="c1"># Out</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="s2">&quot;Waterdemand5b&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">waterbalance_module</span><span class="o">.</span><span class="n">waterBalanceCheck</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ind_efficiency</span> <span class="o">*</span> <span class="n">frac_industry</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrWithdrawal</span><span class="p">],</span>  <span class="c1"># In</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_indConsumption</span><span class="p">],</span>  <span class="c1"># Out</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="s2">&quot;Waterdemand5c&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">waterbalance_module</span><span class="o">.</span><span class="n">waterBalanceCheck</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_indWithdrawal</span><span class="p">],</span>  <span class="c1"># In</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_indConsumption</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">ind_efficiency</span><span class="p">],</span>  <span class="c1"># Out</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="s2">&quot;Waterdemand5d&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="c1"># ----------------------------------------------------------------</span>
            <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;calcWaterBalance&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">waterbalance_module</span><span class="o">.</span><span class="n">waterBalanceCheck</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrWithdrawal</span><span class="p">],</span>  <span class="c1"># In</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalIrrConsumption</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowIrr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmet_lostirr</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">addtoevapotrans</span><span class="p">],</span>  <span class="c1"># Out</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="s2">&quot;Waterlossdemand1&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">waterbalance_module</span><span class="o">.</span><span class="n">waterBalanceCheck</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonIrrDemand</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">totalIrrDemand</span><span class="p">],</span>  <span class="c1"># In</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemand</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span><span class="p">],</span>  <span class="c1"># Out</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="s2">&quot;Waterdemand1&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">checkOption</span><span class="p">(</span><span class="s1">&#39;includeWaterBodies&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">waterbalance_module</span><span class="o">.</span><span class="n">waterBalanceCheck</span><span class="p">(</span>
                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span><span class="p">],</span>  <span class="c1"># In</span>
                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_bigLakeResAbst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_smallLakeResAbst</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_channelAbst</span><span class="p">],</span>  <span class="c1"># Out</span>
                        <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                        <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                        <span class="s2">&quot;Waterdemand1b&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">waterbalance_module</span><span class="o">.</span><span class="n">waterBalanceCheck</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">nonFossilGroundwaterAbs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmetDemand</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_SurfaceWaterAbstract</span><span class="p">],</span>  <span class="c1"># In</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalWaterWithdrawal</span><span class="p">],</span>  <span class="c1"># Out</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="s2">&quot;Waterdemand2&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">waterbalance_module</span><span class="o">.</span><span class="n">waterBalanceCheck</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalWaterWithdrawal</span><span class="p">],</span>  <span class="c1"># In</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrPaddyWithdrawal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_irrNonpaddyWithdrawal</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrWithdrawal</span><span class="p">],</span>  <span class="c1"># Out</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="s2">&quot;Waterdemand3&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">waterbalance_module</span><span class="o">.</span><span class="n">waterBalanceCheck</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalWaterWithdrawal</span><span class="p">],</span>  <span class="c1"># In</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalIrrConsumption</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrConsumption</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">addtoevapotrans</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowIrr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnflowNonIrr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmet_lost</span><span class="p">],</span>  <span class="c1"># Out</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="s2">&quot;Waterdemand4&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">waterbalance_module</span><span class="o">.</span><span class="n">waterBalanceCheck</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalWaterWithdrawal</span><span class="p">],</span>  <span class="c1"># In</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalIrrConsumption</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_nonIrrConsumption</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">addtoevapotrans</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">returnFlow</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">unmet_lost</span><span class="p">],</span>  <span class="c1"># Out</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="s2">&quot;Waterdemand5&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">waterbalance_module</span><span class="o">.</span><span class="n">waterBalanceCheck</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">act_totalWaterWithdrawal</span><span class="p">],</span>  <span class="c1"># In</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">waterabstraction</span><span class="p">],</span>  <span class="c1"># Out</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="p">[</span><span class="nb">globals</span><span class="o">.</span><span class="n">inZero</span><span class="p">],</span>
                    <span class="s2">&quot;Waterdemand level1&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, IIASA Water Security.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>